<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		 
			
  
    <meta name="twitter:card" content="summary"/>
    
      <meta name="twitter:image" content="https://vmresu.me/images/avatar.png" />
    
  
  
  <meta name="twitter:title" content="Building A Simple IoT Light Switch"/>
  <meta name="twitter:description" content="I&rsquo;m lucky enough to own a Philips Hue wireless lighting unit (thanks NUACM!) which essentially is this really awesome Internet of Things (IoT) product that lets me replace all my standard light bulbs with special RGB ones that can be controlled wirelessly. The bulbs communicate via ZigBee with a &ldquo;Bridge&rdquo; unit that is connected to my local network and hosts an HTTP API for interfacing with the lights. This API is used by the official Hue mobile app for controlling the lights, but is also publicly documented and totally hacker friendly."/>
  
    <meta name="twitter:site" content="@offlinemark"/>
  
  
  
  
    <meta name="twitter:creator" content="@Mark Mossberg"/>
  



		
		<meta name="author" content="Mark Mossberg">
		<meta name="description" content="Hacker Nonsense">
		<meta name="generator" content="Hugo 0.59.0" />
		<title>Building A Simple IoT Light Switch &middot; Mark Mossberg&#39;s Blog</title>
		<link rel="shortcut icon" href="https://vmresu.me/images/favicon.ico">
		<link rel="stylesheet" href="https://vmresu.me/css/style.css">
		<link rel="stylesheet" href="https://vmresu.me/css/highlight.css">

		
		<link rel="stylesheet" href="https://vmresu.me/css/font-awesome.min.css">
		

		
		<link href="https://vmresu.me/index.xml" rel="alternate" type="application/rss+xml" title="Mark Mossberg&#39;s Blog" />
		

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://vmresu.me/'> <span class="arrow">← </span>Home</a>
	
	<a href='https://vmresu.me/about'>About</a>
	<a href='https://vmresu.me/posts'>Archive</a>
	<a href='https://vmresu.me/tags'>Tags</a>

	

	
	
	<a  href="https://vmresu.me/index.xml">Subscribe</a>
	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        Building A Simple IoT Light Switch
                    </h1>
                    <h2 class="headline">
                    Jan 18, 2015
                    · 549 words
                    · 3 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://vmresu.me/tags/programming">programming</a>
                          
                              <a href="https://vmresu.me/tags/python">python</a>
                          
                              <a href="https://vmresu.me/tags/hardware">hardware</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    

<p>I&rsquo;m lucky enough to own a <a href="http://www.meethue.com">Philips Hue</a> wireless
lighting unit (thanks <a href="http://acm.ccs.neu.edu">NUACM</a>!) which essentially is
this really awesome Internet of Things (IoT) product that lets me replace
all my standard light bulbs with special RGB ones that can be controlled
wirelessly. The bulbs communicate via
<a href="http://en.wikipedia.org/wiki/ZigBee">ZigBee</a> with a &ldquo;Bridge&rdquo; unit that
is connected to my local network and hosts an HTTP API for interfacing
with the lights. This API is used by the official Hue mobile app for controlling
the lights, but is also publicly documented and totally hacker friendly.
The lights are awesome, but it is a bit of a drag to have to use an app
to turn them all off rather than having some physical switch <sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>, so I decided
to fully embrace the IoT trend and use my Raspberry Pi to build a simple
HTTP-fluent light switch for turning my lights on and off.</p>

<h3 id="hardware">Hardware</h3>

<p>The circuitry itself is literally as simple as it gets for this kind of thing,
all I have is GPIO pin 11 on the board (BCM pin 17) connected to pin 6 (GND),
with a switch in between. In my code, I&rsquo;ll configure pin 17 to use an internal
pull up resistor which will bring the voltage up to 3.3V when the button is not
pressed and down to 0V when it is.</p>

<p><img src="/img/rpi.jpg" alt="" /></p>

<h3 id="software">Software</h3>

<p>The Raspberry Pi Python library makes it really easy to control circuits. For
simplicity, my code uses a polling approach to detect when the button is pressed
but the RPi library also supports real callbacks using threading.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">():</span>
    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#3465a4">True</span><span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000">inp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gpio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">input</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PIN</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#8f5902;font-style:italic"># pull up resistor will cause inp to be True when button is not</span>
        <span style="color:#8f5902;font-style:italic"># pressed and False when button is pressed</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">inp</span><span style="color:#000;font-weight:bold">:</span>
            <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">()</span>
        <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BUTTON_SLEEP</span><span style="color:#000;font-weight:bold">)</span></code></pre></div>
<p>My <code>callback()</code> function consists of code that uses the Hue API to request
a diagnostic of the lights, which comes back as a JSON blob with each light
represented as an object. If no lights are on, it turns them on, otherwise
turning them all off. Turning the lights on and off is as simple as submitting
a PUT request to the API endpoint for each light with a JSON blob specifying
the state to turn to (On=True, Off=False).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">():</span>
    <span style="color:#000">survey</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">requests</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BASE</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#39;/lights&#39;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">survey</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">loads</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">survey</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">text</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">numlights</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">survey</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#8f5902;font-style:italic"># if any are on, turn all off.</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">any</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">survey</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)][</span><span style="color:#4e9a06">&#39;state&#39;</span><span style="color:#000;font-weight:bold">][</span><span style="color:#4e9a06">&#39;on&#39;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">numlights</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)]):</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">light</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">survey</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">():</span>
            <span style="color:#000">turn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">light</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">False</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">print</span> <span style="color:#4e9a06">&#39;[{}] Off&#39;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datetime</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">datetime</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">())</span>
    <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#8f5902;font-style:italic"># else if all are off, then all on</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">light</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">survey</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">():</span>
            <span style="color:#000">turn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">light</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">True</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#204a87;font-weight:bold">print</span> <span style="color:#4e9a06">&#39;[{}] On&#39;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">datetime</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">datetime</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">())</span>


<span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">turn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">light</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">state</span><span style="color:#000;font-weight:bold">):</span>
    <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dumps</span><span style="color:#000;font-weight:bold">({</span><span style="color:#4e9a06">&#39;on&#39;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">state</span><span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000">requests</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BASE</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#39;/lights/{}/state&#39;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">light</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span></code></pre></div>
<p>That&rsquo;s it! I leave the script running in a tmux pane on the Pi and I can
hit the button at any point to toggle the lights on and off. The full code
is available on <a href="https://github.com/mossberg/raspi/blob/master/hue.py">github</a>.</p>

<p>For future work,
it would be cool to integrate RF chips so the button wouldn&rsquo;t have to be
physically attached to the Pi and I could have a little remote control. I&rsquo;ll
leave that for another day. Thanks for reading!</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Of course I could physically go to each light and flip the switch but manually turning off all three lights in my room is even more work than launching the app.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>

                </section>
            </article>

            
                <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fvmresu.me%2fposts%2f2015-01-18-a-simple-iot-light-switch%2f - Building%20A%20Simple%20IoT%20Light%20Switch by @offlinemark"><span class="icon-twitter"> tweet</span></a> | 

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'markmossberg'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

            

            

            <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://www.github.com/offlinemark">
        <i class="fa fa-github-square"></i>
    </a>
    
    <a class="symbol" href="https://www.twitter.com/offlinemark">
        <i class="fa fa-twitter-square"></i>
    </a>
    


</div>

    
    <p class="small">
    
       © Copyright 2019 <i class="fa fa-heart" aria-hidden="true"></i> Mark Mossberg
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>

        <script src="https://vmresu.me/js/jquery-3.3.1.min.js"></script>
<script src="https://vmresu.me/js/main.js"></script>
<script src="https://vmresu.me/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-36552439-2', 'auto');
	
	ga('send', 'pageview');
}
</script>





    </body>
</html>
