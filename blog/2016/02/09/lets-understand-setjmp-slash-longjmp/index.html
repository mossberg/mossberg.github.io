
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Let&#8217;s Understand: Setjmp()/longjmp() - Mark Mossberg&#8217;s Blog</title>
  <meta name="author" content="Mark Mossberg">

  
  <meta name="description" content="Pretty recently I learned about setjmp() and longjmp(). They&rsquo;re a
neat pair of libc functions which allow you to save your program&rsquo;s &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://vmresu.me/blog/2016/02/09/lets-understand-setjmp-slash-longjmp/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mark Mossberg's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36552439-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mark Mossberg&#8217;s Blog</a></h1>
  
    <h2>Hacker Nonsense</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="vmresu.me">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/projects">Projects</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Let&#8217;s Understand: Setjmp()/longjmp()</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-02-09'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Pretty recently I learned about <code>setjmp()</code> and <code>longjmp()</code>. They&rsquo;re a
neat pair of libc functions which allow you to save your program&rsquo;s current
execution context and resume it at an arbitrary point in the future (with
some caveats<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>).
If you&rsquo;re wondering why this is particularly useful, to quote
the <a href="http://linux.die.net/man/3/setjmp">manpage</a>, one of their main use cases
is &ldquo;&hellip;for dealing with errors and
interrupts encountered in a low-level subroutine of a program.&rdquo; These functions
can be used for more sophisticated error handling than simple error
code return values.</p>

<p>I was curious
how these functions worked, so I decided to take a look
at <a href="http://git.musl-libc.org/cgit/musl/tree/src/setjmp/i386">musl libc&rsquo;s</a>
implementation for x86.
First, I&rsquo;ll explain their interfaces and show an example usage program.
Next, since this post isn&rsquo;t aimed at the assembly wizard, I&rsquo;ll cover some
basics of x86 and Linux calling convention to provide some required background
knowledge.
Lastly, I&rsquo;ll walk through the source, line by line.</p>

<h2>Interfaces</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">setjmp</span><span class="p">(</span><span class="kt">jmp_buf</span> <span class="n">env</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>setjmp()</code> takes a single <code>jmp_buf</code> opaque type, returns 0, and continues
execution afterward normally. A <code>jmp_buf</code> is the
structure that <code>setjmp()</code> will save the calling execution context in. We&rsquo;ll
examine it more closely later on.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">longjmp</span><span class="p">(</span><span class="kt">jmp_buf</span> <span class="n">env</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>longjmp()</code> takes a <code>jmp_buf</code> and an <code>int</code>, simply returning back the given
<code>int</code> value (unless it was 0, in which case it returns 1). The unusual aspect
is that when it returns, the program&rsquo;s execution resumes as if <code>setjmp()</code> had
just been called. This allows the user to jump back an arbitrary amount of
frames on the current call stack (presumably out of some deep routine which had
an error). The return value allows the code following the <code>setjmp()</code> call to
differentiate if <code>setjmp()</code> or <code>longjmp()</code> had just been called, and proceed
accordingly.</p>

<p>Here&rsquo;s a simple example.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;setjmp.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">fancy_func</span><span class="p">(</span><span class="kt">jmp_buf</span> <span class="n">env</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">jmp_buf</span> <span class="n">env</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">setjmp</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">puts</span><span class="p">(</span><span class="s">&quot;just returning from setjmp!&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fancy_func</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">puts</span><span class="p">(</span><span class="s">&quot;now returning from longjmp and exiting!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">fancy_func</span><span class="p">(</span><span class="kt">jmp_buf</span> <span class="n">env</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;doing fancy stuff&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">longjmp</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">main</span>
</span><span class='line'><span class="n">just</span> <span class="n">returning</span> <span class="n">from</span> <span class="n">setjmp</span><span class="o">!</span>
</span><span class='line'><span class="n">doing</span> <span class="n">fancy</span> <span class="n">stuff</span>
</span><span class='line'><span class="n">now</span> <span class="n">returning</span> <span class="n">from</span> <span class="n">longjmp</span> <span class="n">and</span> <span class="n">exiting</span><span class="o">!</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code creates a <code>jmp_buf</code> and calls <code>setjmp()</code>, saving the current
execution context. Since <code>setjmp()</code> returns 0, the code follows the
first branch, calling  <code>fancy_func()</code> and
forwarding on the <code>jmp_buf</code>. <code>fancy_func()</code> does some fancy stuff, then calls
<code>longjmp()</code>, passing in the <code>jmp_buf</code> and 1. Execution returns to the if
statement on line 9, except this time, <code>ret</code> is 1 instead of 0, because
we&rsquo;re returning from <code>longjmp()</code>.  Now the code
follows the <code>else</code> path which prints and exits. <sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<h2>Background Knowledge</h2>

<p>I&rsquo;ve mentioned &ldquo;execution context&rdquo; a few times, but let&rsquo;s make that a little
more concrete. In this case, a program&rsquo;s execution context can be defined by
the state of the processor&rsquo;s registers.</p>

<p>On x86, the relevant registers are the general purpose, index, and pointer
registers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">General</span> <span class="nl">Purpose</span><span class="p">:</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span>
</span><span class='line'><span class="nl">Index</span><span class="p">:</span>           <span class="n">esi</span><span class="p">,</span> <span class="n">edi</span>
</span><span class='line'><span class="nl">Pointer</span><span class="p">:</span>         <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span><span class="p">,</span> <span class="n">eip</span>
</span></code></pre></td></tr></table></div></figure>


<p>ebx, ecx, edx, esi, and edi don&rsquo;t have particularly special meaning here and
can be thought of as arbitrary 32 bit storage locations. However eax, ebp, and eip
are a little different.</p>

<ul>
<li>eax is used for function return values (specified by the
<a href="https://en.wikipedia.org/wiki/X86_calling_conventions#cdecl">cdecl</a> calling
convention)</li>
<li>ebp, the frame pointer, contains a pointer to the start of the current stack
frame.</li>
<li>eip, the instruction pointer, contains a pointer to the next instruction to
execute.</li>
</ul>


<p>With this in mind, I initially thought that a <code>jmp_buf</code> would be an array
of 9 ints or something, in order to hold each register.</p>

<p>As it happens, <code>jmp_buf</code> is instead declared as (<a href="http://git.musl-libc.org/cgit/musl/tree/include/setjmp.h#n12">link</a>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">__jmp_buf_tag</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">__jmp_buf</span> <span class="n">__jb</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__fl</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__ss</span><span class="p">[</span><span class="mi">128</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)];</span>
</span><span class='line'><span class="p">}</span> <span class="kt">jmp_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>And for x86, <code>__jmp_buf</code> is declared as (<a href="http://git.musl-libc.org/cgit/musl/tree/arch/i386/bits/setjmp.h#n1">link</a>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__jmp_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>I had never seen this syntax of using bracket operators at the end of a typedef
but searched and found out that the <code>__jmp_buf</code> declaration
declares a fixed size array of 6 unsigned longs, and the <code>jmp_buf</code> declaration
declares an array of 1 <code>struct __jmp_buf_tag</code>. The reason for the array of 1
is so the pointer semantics of arrays kick in and the <code>struct __jmp_buf_tag</code>
is actually passed by reference in calls to <code>setjmp()</code>/<code>longjmp()</code> (as opposed
to being copied).</p>

<p>Anyway, apparently my guess of 9 ints was incorrect, and it&rsquo;s actually 6 (longs).</p>

<p>Before we
can dig into the source to understand why this is,
we need to understand what the state of
the program stack is at the point <code>setjmp()</code> is called, and to do that, we need
to understand
which calling convention is being used. Since we assume x86 Linux, this will
be <a href="https://en.wikipedia.org/wiki/X86_calling_conventions#cdecl">cdecl</a>. The
relevant parts of cdecl for this case are:</p>

<ul>
<li>arguments passed on the stack</li>
<li>integer values and memory addresses returned in eax (as mentioned above)</li>
<li>eax, ecx, edx are caller saved, the rest are callee saved</li>
</ul>


<p><code>setjmp()</code>&rsquo;s code executes immediately
after <code>setjmp()</code>&rsquo;s <code>call</code> instruction, so at the point the first
instruction of <code>setjmp()</code> executes, the stack looks something like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">&gt;</span> <span class="n">high</span> <span class="n">memory</span> <span class="o">&lt;</span>
</span><span class='line'><span class="o">|</span> <span class="p">...</span>                       <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">caller</span> <span class="n">saved</span> <span class="n">eip</span> <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">caller</span> <span class="n">saved</span> <span class="n">ebp</span> <span class="o">|</span> <span class="o">&lt;</span> <span class="n">ebp</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span> <span class="n">stack</span> <span class="n">var</span> <span class="mi">1</span>        <span class="o">|</span> <span class="c1">// caller&#39;s stack frame</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span> <span class="n">stack</span> <span class="n">var</span> <span class="mi">2</span>        <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span> <span class="n">stack</span> <span class="n">var</span> <span class="p">...</span>      <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span> <span class="n">stack</span> <span class="n">var</span> <span class="n">n</span>        <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">pointer</span> <span class="n">to</span> <span class="kt">jmp_buf</span>        <span class="o">|</span> <span class="c1">// argument to setjmp</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span> <span class="n">saved</span> <span class="n">eip</span>          <span class="o">|</span> <span class="o">&lt;</span> <span class="n">esp</span>
</span><span class='line'><span class="o">+---------------------------+</span> <span class="c1">// setjmp&#39;s stack frame</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">low</span> <span class="n">memory</span> <span class="o">&lt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>(In this illustration, the stack grows down.)</p>

<p>At the top of the stack is the eip value that the <code>call</code> instruction pushed,
or where to return to after <code>setjmp()</code> finishes. Above that is the first,
and only argument, the pointer to the given <code>jmp_buf</code>. Lastly, above that is
the caller&rsquo;s stack frame.
esp points to the top
of the stack as usual, and ebp is still pointing to the start of the caller&rsquo;s
stack
frame. Usually the first thing a function does is push
ebp on the stack, and set ebp to esp to now point to the current stack frame (a.k.a the prologue),
but since <code>setjmp()</code> is such a minimal function, it doesn&rsquo;t do this.
Furthermore, since ebp is one of the registers that needs to be saved, <code>setjmp()</code>
needs it to be unperturbed.</p>

<p>After <code>setjmp()</code> returns, the stack will look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">&gt;</span> <span class="n">high</span> <span class="n">memory</span> <span class="o">&lt;</span>
</span><span class='line'><span class="o">|</span> <span class="p">...</span>                       <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">saved</span> <span class="n">caller</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">caller</span> <span class="n">eip</span> <span class="o">|</span> <span class="o">&lt;</span> <span class="n">ebp</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span> <span class="n">stack</span> <span class="n">var</span> <span class="mi">1</span>        <span class="o">|</span> <span class="c1">// caller&#39;s stack frame</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span> <span class="n">stack</span> <span class="n">var</span> <span class="mi">2</span>        <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span> <span class="n">stack</span> <span class="n">var</span> <span class="p">...</span>      <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">caller</span> <span class="n">stack</span> <span class="n">var</span> <span class="n">n</span>        <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">pointer</span> <span class="n">to</span> <span class="kt">jmp_buf</span>        <span class="o">|</span> <span class="o">&lt;</span> <span class="n">esp</span>
</span><span class='line'><span class="o">+---------------------------+</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">low</span> <span class="n">memory</span> <span class="o">&lt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s nearly identical, except eip has been popped off the stack, and is now
executing the next instruction after the caller&rsquo;s <code>call setjmp</code>. esp has
also been updated accordingly. This is the state of the program that <code>setjmp()</code>
will need to record, and that <code>longjmp()</code> will restore.</p>

<p>Before reading the source I tried to reason about what I expected would happen.
I presume:</p>

<ul>
<li>General purpose and index registers (eax, ebx, ecx, edx, esi, edi) which don&rsquo;t
  have any effect on control flow can be trivially saved and restored</li>
<li>ebp can similarly be saved &ldquo;as is&rdquo;, since its value when
<code>setjmp()</code> executes is exactly what it needs to be restored to in <code>longjmp()</code></li>
<li>esp cannot be saved &ldquo;as is&rdquo; because when <code>setjmp()</code> executes, there is the
extra eip on the stack that is not there after the function returns. Therefore,
the value for esp that should be saved is esp+4 to match the expected
state of the stack after return</li>
<li>The eip that should be saved is the address of the instruction after the
<code>call setjmp</code> instruction, which can be retrieved from the top of the
stack by dereferencing esp</li>
</ul>


<p>With all that out of the way, let&rsquo;s read the source (all annotations by me)
(<a href="http://git.musl-libc.org/cgit/musl/tree/src/setjmp/i386/setjmp.s">link</a>).
Since this type of low level register manipulation isn&rsquo;t available from C
(modulo compiler intrinsics), both of these functions are necessarily written
in assembly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nl">setjmp:</span>
</span><span class='line'>    <span class="nf">mov</span> <span class="mi">4</span><span class="p">(</span><span class="nv">%esp</span><span class="p">),</span> <span class="nv">%eax</span>     <span class="err">;</span> <span class="no">get</span> <span class="no">pointer</span> <span class="no">to</span> <span class="no">jmp_buf</span><span class="p">,</span> <span class="no">passed</span> <span class="no">as</span> <span class="no">argument</span> <span class="no">on</span> <span class="no">stack</span>
</span><span class='line'>    <span class="nf">mov</span>    <span class="nv">%ebx</span><span class="p">,</span> <span class="p">(</span><span class="nv">%eax</span><span class="p">)</span>   <span class="err">;</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">0</span><span class="err">]</span> <span class="err">=</span> <span class="no">ebx</span>
</span><span class='line'>    <span class="nf">mov</span>    <span class="nv">%esi</span><span class="p">,</span> <span class="mi">4</span><span class="p">(</span><span class="nv">%eax</span><span class="p">)</span>  <span class="err">;</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">1</span><span class="err">]</span> <span class="err">=</span> <span class="no">esi</span>
</span><span class='line'>    <span class="nf">mov</span>    <span class="nv">%edi</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="nv">%eax</span><span class="p">)</span>  <span class="err">;</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">2</span><span class="err">]</span> <span class="err">=</span> <span class="no">edi</span>
</span><span class='line'>    <span class="nf">mov</span>    <span class="nv">%ebp</span><span class="p">,</span> <span class="mi">12</span><span class="p">(</span><span class="nv">%eax</span><span class="p">)</span> <span class="err">;</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">3</span><span class="err">]</span> <span class="err">=</span> <span class="no">ebp</span>
</span><span class='line'>    <span class="nf">lea</span> <span class="mi">4</span><span class="p">(</span><span class="nv">%esp</span><span class="p">),</span> <span class="nv">%ecx</span>     <span class="err">;</span> <span class="no">get</span> <span class="no">previous</span> <span class="no">value</span> <span class="no">of</span> <span class="no">esp</span><span class="p">,</span> <span class="no">before</span> <span class="no">call</span>
</span><span class='line'>    <span class="nf">mov</span>    <span class="nv">%ecx</span><span class="p">,</span> <span class="mi">16</span><span class="p">(</span><span class="nv">%eax</span><span class="p">)</span> <span class="err">;</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">4</span><span class="err">]</span> <span class="err">=</span> <span class="no">esp</span> <span class="no">before</span> <span class="no">call</span>
</span><span class='line'>    <span class="nf">mov</span>  <span class="p">(</span><span class="nv">%esp</span><span class="p">),</span> <span class="nv">%ecx</span>     <span class="err">;</span> <span class="no">get</span> <span class="no">saved</span> <span class="no">caller</span> <span class="no">eip</span> <span class="no">from</span> <span class="no">top</span> <span class="no">of</span> <span class="no">stack</span>
</span><span class='line'>    <span class="nf">mov</span>    <span class="nv">%ecx</span><span class="p">,</span> <span class="mi">20</span><span class="p">(</span><span class="nv">%eax</span><span class="p">)</span> <span class="err">;</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">5</span><span class="err">]</span> <span class="err">=</span> <span class="no">saved</span> <span class="no">eip</span>
</span><span class='line'>    <span class="nf">xor</span>    <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%eax</span>     <span class="err">;</span> <span class="no">eax</span> <span class="err">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="nf">ret</span>                   <span class="err">;</span> <span class="no">pop</span> <span class="no">stack</span> <span class="no">into</span> <span class="no">eip</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line retrieves the argument off the stack, placing a pointer to
the <code>jmp_buf</code> (remember, an array of 6 unsigned longs) in eax. It then moves
ebx, esi,
edi, and ebp &ldquo;as is&rdquo; into the int array. It adds 4 to esp with a <code>lea</code> and
stores that next. Next, it dereferences esp and stores that in the last slot
in the array. Lastly, it zeroes out eax and returns.</p>

<p>The final state of the <code>jmp_buf</code> after <code>setjmp()</code> returns looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'>   <span class="err">0</span>    <span class="err">1</span>    <span class="err">2</span>    <span class="err">3</span>    <span class="err">4</span>    <span class="err">5</span>
</span><span class='line'><span class="err">[</span> <span class="nf">ebx</span><span class="p">,</span> <span class="no">esi</span><span class="p">,</span> <span class="no">edi</span><span class="p">,</span> <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span><span class="p">,</span> <span class="no">eip</span> <span class="err">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s look at <code>longjmp()</code> (<a href="http://git.musl-libc.org/cgit/musl/tree/src/setjmp/i386/longjmp.s">link</a>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nl">longjmp:</span>
</span><span class='line'>    <span class="nf">mov</span>  <span class="mi">4</span><span class="p">(</span><span class="nv">%esp</span><span class="p">),</span><span class="nv">%edx</span> <span class="err">;</span> <span class="no">get</span> <span class="no">pointer</span> <span class="no">to</span> <span class="no">jmp_buf</span><span class="p">,</span> <span class="no">passed</span> <span class="no">as</span> <span class="no">argument</span> <span class="mi">1</span> <span class="no">on</span> <span class="no">stack</span>
</span><span class='line'>    <span class="nf">mov</span>  <span class="mi">8</span><span class="p">(</span><span class="nv">%esp</span><span class="p">),</span><span class="nv">%eax</span> <span class="err">;</span> <span class="no">get</span> <span class="no">int</span> <span class="no">val</span> <span class="no">in</span> <span class="no">eax</span><span class="p">,</span> <span class="no">passed</span> <span class="no">as</span> <span class="no">argument</span> <span class="mi">2</span> <span class="no">on</span> <span class="no">stack</span>
</span><span class='line'>    <span class="nf">test</span>    <span class="nv">%eax</span><span class="p">,</span><span class="nv">%eax</span> <span class="err">;</span> <span class="no">is</span> <span class="no">int</span> <span class="no">val</span> <span class="err">==</span> <span class="mi">0</span><span class="err">?</span>
</span><span class='line'>    <span class="nf">jnz</span> <span class="mi">1</span><span class="no">f</span>
</span><span class='line'>    <span class="nf">inc</span>     <span class="nv">%eax</span>      <span class="err">;</span> <span class="no">if</span> <span class="no">so</span><span class="p">,</span> <span class="no">eax</span><span class="err">++</span>
</span><span class='line'><span class="err">1:</span>
</span><span class='line'>    <span class="nf">mov</span>   <span class="p">(</span><span class="nv">%edx</span><span class="p">),</span><span class="nv">%ebx</span> <span class="err">;</span> <span class="no">ebx</span> <span class="err">=</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">0</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">mov</span>  <span class="mi">4</span><span class="p">(</span><span class="nv">%edx</span><span class="p">),</span><span class="nv">%esi</span> <span class="err">;</span> <span class="no">esi</span> <span class="err">=</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">1</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">mov</span>  <span class="mi">8</span><span class="p">(</span><span class="nv">%edx</span><span class="p">),</span><span class="nv">%edi</span> <span class="err">;</span> <span class="no">edi</span> <span class="err">=</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">2</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">mov</span> <span class="mi">12</span><span class="p">(</span><span class="nv">%edx</span><span class="p">),</span><span class="nv">%ebp</span> <span class="err">;</span> <span class="no">ebp</span> <span class="err">=</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">3</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">mov</span> <span class="mi">16</span><span class="p">(</span><span class="nv">%edx</span><span class="p">),</span><span class="nv">%ecx</span> <span class="err">;</span> <span class="no">ecx</span> <span class="err">=</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">4</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">mov</span>     <span class="nv">%ecx</span><span class="p">,</span><span class="nv">%esp</span> <span class="err">;</span> <span class="no">esp</span> <span class="err">=</span> <span class="no">ecx</span>
</span><span class='line'>    <span class="nf">mov</span> <span class="mi">20</span><span class="p">(</span><span class="nv">%edx</span><span class="p">),</span><span class="nv">%ecx</span> <span class="err">;</span> <span class="no">ecx</span> <span class="err">=</span> <span class="no">jmp_buf</span><span class="err">[</span><span class="mi">5</span><span class="err">]</span>
</span><span class='line'>    <span class="nf">jmp</span> <span class="p">*</span><span class="nv">%ecx</span>         <span class="err">;</span> <span class="no">eip</span> <span class="err">=</span> <span class="no">ecx</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first two lines retrieve the arguments (pointer to <code>jmp_buf</code>, int return
val) from the stack into edx and eax, respectively. The int val is
incremented to 1 if it is 0, according to the spec. Next, ebx, esi, edi, and
ebp are reset
to their saved state, stored in the <code>jmp_buf</code>, in a straightforward manner.
As you can see, both <code>setjmp()</code> and <code>longjmp()</code> need to precisely agree on
where each particular register is saved in the <code>jmp_buf</code>.
esp is mysteriously restored in an indirect manner, via ecx<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup> and
finally, eip is reset to the saved state via an indirect jump.</p>

<p>So I was mostly correct, but it seems like eax, ecx, and edx were not saved
in the <code>jmp_buf</code>!
If we look back on the details of cdecl, it becomes clear why.</p>

<ul>
<li>eax doesn&rsquo;t need to be saved, because it is reserved for the return value</li>
<li>ecx and edx are <strong>caller saved</strong>. This means that a callee subroutine is
free to trash these registers, and it is the responsibility for the caller
to save and restore them after the subroutine returns. Because of this,
if the function that calls <code>setjmp()</code> needs to use ecx or edx after the
call, it will <strong>already</strong> have code to save and restore those registers before
and after the function call. Since <code>longjmp()</code> resumes execution as if
<code>setjmp()</code> had immediately returned, execution will automatically hit the
code that restores ecx and edx, making it unnecessary to save them in the
<code>jmp_buf</code>.</li>
</ul>


<p>This is just one example of how great musl libc is at providing an
<em>understandable</em> resource for learning the internals of systems software. I
often find myself referencing it when I&rsquo;m curious about libc internals, and
if you&rsquo;re not familiar with it, I highly recommend checking it out!</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Mainly, that the function which called <code>setjmp()</code> cannot have returned before the corresponding <code>longjmp()</code> call.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>A slight aside: This situation where a function returns different values based on the execution context also appears in <code>fork()</code>, in which the caller uses the return value to differentiate whether it is now executing in the child or parent process.  <a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>I actually have no good explanation for this and am pretty curious why it&rsquo;s done this way. Something like <code>mov $esp, [$edx+16]</code> is a perfectly valid instruction (tested with <code>rasm2</code>)! I asked on the musl <a href="http://www.openwall.com/lists/musl/2016/01/12/11">mailing list</a>, but no one responded :(. If you have an explanation, please let me know!<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mark Mossberg</span></span>

      




<time class='entry-date' datetime='2016-02-09'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>12:00 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/assembly/'>assembly</a>, <a class='category' href='/blog/categories/linux/'>linux</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://vmresu.me/blog/2016/02/09/lets-understand-setjmp-slash-longjmp/" data-via="" data-counturl="http://vmresu.me/blog/2016/02/09/lets-understand-setjmp-slash-longjmp/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/06/14/building-a-simple-iot-light-switch/" title="Previous Post: Building a Simple IoT Light Switch, Pt. 2">&laquo; Building a Simple IoT Light Switch, Pt. 2</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>External</h1>
  <ul>
      <li>twitter: <a href="http://twitter.com/markmossberg">@markmossberg</a></li>
      <li>github: <a href="http://github.com/mossberg">@mossberg</a></li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/02/09/lets-understand-setjmp-slash-longjmp/">Let&#8217;s Understand: Setjmp()/longjmp()</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/14/building-a-simple-iot-light-switch/">Building a Simple IoT Light Switch, Pt. 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/07/off-to-the-python-internals-races/">Off to the (Python Internals) Races</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/25/building-a-sketchy-website-101/">Building a Sketchy Website 101</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/18/a-simple-iot-light-switch/">Building a Simple IoT Light Switch</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/android'>android (1)</a></li><li><a href='/blog/categories/assembly'>assembly (2)</a></li><li><a href='/blog/categories/ctf'>ctf (2)</a></li><li><a href='/blog/categories/hacking'>hacking (7)</a></li><li><a href='/blog/categories/hardware'>hardware (2)</a></li><li><a href='/blog/categories/linux'>linux (5)</a></li><li><a href='/blog/categories/programming'>programming (3)</a></li><li><a href='/blog/categories/python'>python (4)</a></li><li><a href='/blog/categories/reference'>reference (2)</a></li><li><a href='/blog/categories/reverse-engineering'>reverse engineering (2)</a></li><li><a href='/blog/categories/security'>security (6)</a></li><li><a href='/blog/categories/sysadmin'>sysadmin (4)</a></li><li><a href='/blog/categories/web'>web (3)</a></li></ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Mark Mossberg -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'markmossberg';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://vmresu.me/blog/2016/02/09/lets-understand-setjmp-slash-longjmp/';
        var disqus_url = 'http://vmresu.me/blog/2016/02/09/lets-understand-setjmp-slash-longjmp/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
