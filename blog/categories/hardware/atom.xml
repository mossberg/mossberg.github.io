<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Hardware | Mark Mossberg's Blog]]></title>
  <link href="http://vmresu.me/blog/categories/hardware/atom.xml" rel="self"/>
  <link href="http://vmresu.me/"/>
  <updated>2016-01-24T22:49:31-05:00</updated>
  <id>http://vmresu.me/</id>
  <author>
    <name><![CDATA[Mark Mossberg]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Building a Simple IoT Light Switch, Pt. 2]]></title>
    <link href="http://vmresu.me/blog/2015/06/14/building-a-simple-iot-light-switch/"/>
    <updated>2015-06-14T15:13:07-04:00</updated>
    <id>http://vmresu.me/blog/2015/06/14/building-a-simple-iot-light-switch</id>
    <content type="html"><![CDATA[<p>This is a pretty late post, but I wanted to show off the hardware I designed
as a follow up to the first
<a href="/blog/2015/01/18/a-simple-iot-light-switch/">&ldquo;Building a Simple IoT Light Switch&rdquo;</a>.
In that post I presented a prototype of a smart light switch I designed that
consisted of a button which triggered a small Python server running on a
Raspberry Pi to control my Phillips Hue lights over an HTTP API. It was an
extraordinarily simple design that worked well enough, how it was very
inconvenient to transport since I had to rewire the breadboard to the raspi
GPIO pins every time I moved. Since it seemed production ready
for my needs, I decided to solve this problem by using this as an opportunity
to learn PCB design and actually design a production board.</p>

<p>Special thanks go to <a href="http://nickkubasti.com/">Nick Kubasti</a> for teaching me
how to use KiCad and to <a href="http://thejohnsullivan.com/">John Sullivan</a> for helping
me with the final lab work.</p>

<p>The basic circuit I designed is below. It is merely a GPIO pin hooked up to
ground with a switch in between, and an LED and resistor for fun.</p>

<p><img src="/images/iot2/switch1.png" alt="" /></p>

<p>The code behind this configures the GPIO pin to use a pull up resistor, which
pulls the pin&rsquo;s voltage up to VCC when the button is not pressed, and down to
GND when it is. This lets the code poll for when the pin&rsquo;s value is <code>False</code>.
A more complete schematic including the pull up resistor is below. Note that
I won&rsquo;t have to implement the pull up part in my design because the Raspberry
Pi implements that internally.</p>

<p><img src="/images/iot2/switch2.png" alt="" /></p>

<p>My initial idea was to have a little board that would plug straight down into
the Pi&rsquo;s GPIO male headers with a little button and LED at the end. However,
that was really wasteful since that would block all of the pins even though
I was only using three of them (input, GND, VCC). Nick suggested a board design
that had two sets of headers: one set of female ones for plugging downwards as I
had originally thought, and one set of male ones facing upward that all the
unused pins would be forwarded to. This way, even though the downward facing
female pins are all plugged in, they can all still be accessed since the board
traces simply connect the unused female pins to the corresponding male ones.
The exception to this is GPIO pin 11, which is the one actually being used for
the switch. I just need to remember for future projects that pin 11 is
reserved. That was probably really hard to understand, so here&rsquo;s the schematic,
created with KiCad.</p>

<p><img src="/images/iot2/schematic.png" alt="" /></p>

<p>On the left you can see the two sets of 13 x 2 headers. The ones on the left
will be the female ones that plug downward into the Pi&rsquo;s male headers. The
ones on the right will be the male ones that can be used for other projects.
All those wires going around the top and bottom are the forwarded connections.
The one pin exclusively in use on the left is pin 11, which is connected to
the circuit. All the rest are unused, and wires are used to connect them to
their corresponding male header. Pins 1 and 9 are technically in use, but
since they correspond to VCC and GND, it&rsquo;s fine to forward them too.</p>

<p>The actual circuit is in the bottom left. It&rsquo;s very similar to the above
circuit diagrams, pin 11 is connected to GND (pin 9) via a switch, and
3.3V VCC (pin 1) is connected to an LED, resistor, and the same GND (pin 9).</p>

<p>The next step after creating the schematic, and assigning actual parts to each
of the components, was to design the printed circuit board (PCB). This involves
laying out the components as they will appear on the physical
silicon wafer.</p>

<p><img src="/images/iot2/pcb.png" alt="" /></p>

<p>This was a completely new area to me and it was challenging and fun to
actually draw out the board&rsquo;s traces, taking care not to intersect them,
and using the different layers when necessary. You might notice that there&rsquo;s
a seemingly random set of 1 x 2 headers in the middle of the area where the
switch goes. I added those because I noticed that the button and LED were going
to actually extend off the end of the Pi. I was concerned about how pressing
down on the button would actually flip the Pi a little bit, so Nick had an
incredible idea and suggested adding space for a pair of dud headers that
could be used as legs to support the end of the PCB that hung off the side
of the Pi.</p>

<p>After this, I was then able to pretty easily use KiCad to generate some
Gerber files to send to the fab. I chose to use
<a href="https://oshpark.com/">OshPark</a> based on Nick&rsquo;s recommendation, and they turned
out to be a great option. I was able to get three copies of my board, with
free shipping for &lt;$8!</p>

<p>After waiting a couple of weeks for the boards to come in, John helped me
solder everything together to finish up this project. During this process
we noticed one design mistake: the layout of the switch was actually <em>way</em>
too big for the switch we had on hand, but that didn&rsquo;t turn out to be a serious
issue.</p>

<p><img src="/images/iot2/mistake.jpg" alt="" /></p>

<p>There are some pictures of the final product:</p>

<p><img src="/images/iot2/final1.jpg" alt="" />
<img src="/images/iot2/final2.jpg" alt="" />
<img src="/images/iot2/final3.jpg" alt="" />
<img src="/images/iot2/final4.jpg" alt="" /></p>

<p>Here&rsquo;s a video of it in action:</p>

<blockquote class="instagram-media" data-instgrm-version="4" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/37ZQ8_n86u/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_top">A video posted by Mark Mossberg (@mssbrg)</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-06-14T23:29:39+00:00">Jun 14, 2015 at 4:29pm PDT</time></p></div></blockquote>


<script async defer src="//platform.instagram.com/en_US/embeds.js"></script>


<p>Thanks for reading! I have two extra boards I&rsquo;m not doing anything with, so
if you happen to have a Raspberry Pi and some Hue lights, I&rsquo;d be happy to give
you the hardware and software for your own DIY light switch.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building a Simple IoT Light Switch]]></title>
    <link href="http://vmresu.me/blog/2015/01/18/a-simple-iot-light-switch/"/>
    <updated>2015-01-18T13:32:48-05:00</updated>
    <id>http://vmresu.me/blog/2015/01/18/a-simple-iot-light-switch</id>
    <content type="html"><![CDATA[<p>I&rsquo;m lucky enough to own a <a href="http://www.meethue.com">Philips Hue</a> wireless
lighting unit (thanks <a href="http://acm.ccs.neu.edu">NUACM</a>!) which essentially is
this really awesome Internet of Things (IoT) product that lets me replace
all my standard light bulbs with special RGB ones that can be controlled
wirelessly. The bulbs communicate via
<a href="http://en.wikipedia.org/wiki/ZigBee">ZigBee</a> with a &ldquo;Bridge&rdquo; unit that
is connected to my local network and hosts an HTTP API for interfacing
with the lights. This API is used by the official Hue mobile app for controlling
the lights, but is also publicly documented and totally hacker friendly.
The lights are awesome, but it is a bit of a drag to have to use an app
to turn them all off rather than having some physical switch <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, so I decided
to fully embrace the IoT trend and use my Raspberry Pi to build a simple
HTTP-fluent light switch for turning my lights on and off.</p>

<h3>Hardware</h3>

<p>The circuitry itself is literally as simple as it gets for this kind of thing,
all I have is GPIO pin 11 on the board (BCM pin 17) connected to pin 6 (GND),
with a switch in between. In my code, I&rsquo;ll configure pin 17 to use an internal
pull up resistor which will bring the voltage up to 3.3V when the button is not
pressed and down to 0V when it is.</p>

<p><img src="/images/rpi.jpg" alt="" /></p>

<h3>Software</h3>

<p>The Raspberry Pi Python library makes it really easy to control circuits. For
simplicity, my code uses a polling approach to detect when the button is pressed
but the RPi library also supports real callbacks using threading.</p>

<pre><code class="python">def main():
    while True:
        inp = gpio.input(PIN)
        # pull up resistor will cause inp to be True when button is not
        # pressed and False when button is pressed
        if not inp:
            callback()
        time.sleep(BUTTON_SLEEP)
</code></pre>

<p>My <code>callback()</code> function consists of code that uses the Hue API to request
a diagnostic of the lights, which comes back as a JSON blob with each light
represented as an object. If no lights are on, it turns them on, otherwise
turning them all off. Turning the lights on and off is as simple as submitting
a PUT request to the API endpoint for each light with a JSON blob specifying
the state to turn to (On=True, Off=False).</p>

<pre><code class="python">def callback():
    survey = requests.get(BASE + '/lights')
    survey = json.loads(survey.text)
    numlights = len(survey)
    # if any are on, turn all off.
    if any([survey[str(x)]['state']['on'] for x in range(1, numlights+1)]):
        for light in survey.keys():
            turn(light, False)
        print '[{}] Off'.format(datetime.datetime.now())
    else:  # else if all are off, then all on
        for light in survey.keys():
            turn(light, True)
        print '[{}] On'.format(datetime.datetime.now())


def turn(light, state):
    data = json.dumps({'on':state})
    requests.put(BASE + '/lights/{}/state'.format(light), data=data)
</code></pre>

<p>That&rsquo;s it! I leave the script running in a tmux pane on the Pi and I can
hit the button at any point to toggle the lights on and off. The full code
is available on <a href="https://github.com/mossberg/raspi/blob/master/hue.py">github</a>.</p>

<p>For future work,
it would be cool to integrate RF chips so the button wouldn&rsquo;t have to be
physically attached to the Pi and I could have a little remote control. I&rsquo;ll
leave that for another day. Thanks for reading, here it is in action!</p>

<blockquote class="instagram-media" data-instgrm-version="4" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/yAhhmMn8yt/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_top">A video posted by Mark Mossberg (@mssbrg)</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-01-18T20:09:40+00:00">Jan 18, 2015 at 12:09pm PST</time></p></div></blockquote>


<script async defer src="//platform.instagram.com/en_US/embeds.js"></script>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Of course I could physically go to each light and flip the switch but manually turning off all three lights in my room is even more work than launching the app.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
</feed>
