
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building a Simple IoT Light Switch - Mark Mossberg&#8217;s Blog</title>
  <meta name="author" content="Mark Mossberg">

  
  <meta name="description" content="I&rsquo;m lucky enough to own a Philips Hue wireless
lighting unit (thanks NUACM!) which essentially is
this really awesome Internet of Things (IoT) &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://vmresu.me/blog/2015/01/18/a-simple-iot-light-switch/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mark Mossberg's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36552439-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Mark Mossberg&#8217;s Blog</a></h1>
  
    <h2>Hacker Nonsense</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="vmresu.me">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/projects">Projects</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building a Simple IoT Light Switch</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-18T13:32:48-05:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:32 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&rsquo;m lucky enough to own a <a href="http://www.meethue.com">Philips Hue</a> wireless
lighting unit (thanks <a href="http://acm.ccs.neu.edu">NUACM</a>!) which essentially is
this really awesome Internet of Things (IoT) product that lets me replace
all my standard light bulbs with special RGB ones that can be controlled
wirelessly. The bulbs communicate via
<a href="http://en.wikipedia.org/wiki/ZigBee">ZigBee</a> with a &ldquo;Bridge&rdquo; unit that
is connected to my local network and hosts an HTTP API for interfacing
with the lights. This API is used by the official Hue mobile app for controlling
the lights, but is also publicly documented and totally hacker friendly.
The lights are awesome, but it is a bit of a drag to have to use an app
to turn them all off rather than having some physical switch <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, so I decided
to fully embrace the IoT trend and use my Raspberry Pi to build a simple
HTTP-fluent light switch for turning my lights on and off.</p>

<h3>Hardware</h3>

<p>The circuitry itself is literally as simple as it gets for this kind of thing,
all I have is GPIO pin 11 on the board (BCM pin 17) connected to pin 6 (GND),
with a switch in between. In my code, I&rsquo;ll configure pin 17 to use an internal
pull up resistor which will bring the voltage up to 3.3V when the button is not
pressed and down to 0V when it is.</p>

<p><img src="/images/rpi.jpg" alt="" /></p>

<h3>Software</h3>

<p>The Raspberry Pi Python library makes it really easy to control circuits. For
simplicity, my code uses a polling approach to detect when the button is pressed
but the RPi library also supports real callbacks using threading.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>        <span class="n">inp</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">PIN</span><span class="p">)</span>
</span><span class='line'>        <span class="c"># pull up resistor will cause inp to be True when button is not</span>
</span><span class='line'>        <span class="c"># pressed and False when button is pressed</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">inp</span><span class="p">:</span>
</span><span class='line'>            <span class="n">callback</span><span class="p">()</span>
</span><span class='line'>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">BUTTON_SLEEP</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>My <code>callback()</code> function consists of code that uses the Hue API to request
a diagnostic of the lights, which comes back as a JSON blob with each light
represented as an object. If no lights are on, it turns them on, otherwise
turning them all off. Turning the lights on and off is as simple as submitting
a PUT request to the API endpoint for each light with a JSON blob specifying
the state to turn to (On=True, Off=False).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
</span><span class='line'>    <span class="n">survey</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">BASE</span> <span class="o">+</span> <span class="s">&#39;/lights&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">survey</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">survey</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">numlights</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">survey</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># if any are on, turn all off.</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">survey</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)][</span><span class="s">&#39;state&#39;</span><span class="p">][</span><span class="s">&#39;on&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numlights</span><span class="o">+</span><span class="mi">1</span><span class="p">)]):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">light</span> <span class="ow">in</span> <span class="n">survey</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span class='line'>            <span class="n">turn</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;[{}] Off&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>  <span class="c"># else if all are off, then all on</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">light</span> <span class="ow">in</span> <span class="n">survey</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span class='line'>            <span class="n">turn</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;[{}] On&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">turn</span><span class="p">(</span><span class="n">light</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;on&#39;</span><span class="p">:</span><span class="n">state</span><span class="p">})</span>
</span><span class='line'>    <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">BASE</span> <span class="o">+</span> <span class="s">&#39;/lights/{}/state&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">light</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it! I leave the script running in a tmux pane on the Pi and I can
hit the button at any point to toggle the lights on and off. The full code
is available on <a href="https://github.com/mossberg/raspi/blob/master/hue.py">github</a>.</p>

<p>For future work,
it would be cool to integrate RF chips so the button wouldn&rsquo;t have to be
physically attached to the Pi and I could have a little remote control. I&rsquo;ll
leave that for another day. Thanks for reading, here it is in action!</p>

<blockquote class="instagram-media" data-instgrm-version="4" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://instagram.com/p/yAhhmMn8yt/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_top">A video posted by Mark Mossberg (@mssbrg)</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-01-18T20:09:40+00:00">Jan 18, 2015 at 12:09pm PST</time></p></div></blockquote>


<script async defer src="//platform.instagram.com/en_US/embeds.js"></script>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Of course I could physically go to each light and flip the switch but manually turning off all three lights in my room is even more work than launching the app.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Mark Mossberg</span></span>

      




<time class='entry-date' datetime='2015-01-18T13:32:48-05:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:32 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/hardware/'>hardware</a>, <a class='category' href='/blog/categories/programming/'>programming</a>, <a class='category' href='/blog/categories/python/'>python</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://vmresu.me/blog/2015/01/18/a-simple-iot-light-switch/" data-via="" data-counturl="http://vmresu.me/blog/2015/01/18/a-simple-iot-light-switch/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/12/13/poet-beacon-based-post-exploitation/" title="Previous Post: Poet: Beacon Based Post-Exploitation">&laquo; Poet: Beacon Based Post-Exploitation</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/04/25/building-a-sketchy-website-101/" title="Next Post: Building a Sketchy Website 101">Building a Sketchy Website 101 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>External</h1>
  <ul>
      <li>twitter: <a href="http://twitter.com/markmossberg">@markmossberg</a></li>
      <li>github: <a href="http://github.com/mossberg">@mossberg</a></li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/14/building-a-simple-iot-light-switch/">Building a Simple IoT Light Switch, Pt. 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/07/off-to-the-python-internals-races/">Off to the (Python Internals) Races</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/25/building-a-sketchy-website-101/">Building a Sketchy Website 101</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/18/a-simple-iot-light-switch/">Building a Simple IoT Light Switch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/13/poet-beacon-based-post-exploitation/">Poet: Beacon Based Post-Exploitation</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/android'>android (1)</a></li><li><a href='/blog/categories/assembly'>assembly (1)</a></li><li><a href='/blog/categories/ctf'>ctf (2)</a></li><li><a href='/blog/categories/hacking'>hacking (7)</a></li><li><a href='/blog/categories/hardware'>hardware (2)</a></li><li><a href='/blog/categories/linux'>linux (4)</a></li><li><a href='/blog/categories/programming'>programming (3)</a></li><li><a href='/blog/categories/python'>python (4)</a></li><li><a href='/blog/categories/reference'>reference (2)</a></li><li><a href='/blog/categories/reverse-engineering'>reverse engineering (2)</a></li><li><a href='/blog/categories/security'>security (6)</a></li><li><a href='/blog/categories/sysadmin'>sysadmin (4)</a></li><li><a href='/blog/categories/web'>web (3)</a></li></ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Mark Mossberg -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'markmossberg';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://vmresu.me/blog/2015/01/18/a-simple-iot-light-switch/';
        var disqus_url = 'http://vmresu.me/blog/2015/01/18/a-simple-iot-light-switch/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
